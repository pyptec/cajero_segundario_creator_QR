C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE LECTOR
OBJECT MODULE PLACED IN .\hex\lector.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE lector.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(..\Sec_Creator LPR RenewM
                    - CtrlLuz) DEBUG OBJECTEXTEND TABS(2) OBJECT(.\hex\lector.obj)

line level    source

   1          
   2          #include <lector.h> 
   3          #include <string.h>
   4          #include <reg51.h>
   5          
   6          
   7          sbit lock = P1^7;         //Relevo    
   8          sbit busy = P3^3;           //Entrada Interrupcion del Procesador principal     *
   9          sbit ready = P3^2;          //Salida. solicitud envio Datos   
  10          sbit port_clk = P3^4;       //Recepcion AUX     
  11          sbit rx_in_data = P0^6;       //Indicador de Rx Transporte o Lectura Wiegand      *
  12          sbit sel_com = P0^7;        //Micro switch  
  13          //------------------------------------------------------------------------------------------*
  14          #define SEQ_INICIO        0X00  
  15          #define SEQ_TEMPORAL      0X01
  16          #define SEQ_ESPERA        0X02
  17          #define SEQ_RTA_STATUS      0X03
  18          #define SEQ_RTA_EJECT     0X04
  19          #define SEQ_RTA_LOADKEY     0x05
  20          #define SEQ_RTA_SELECT      0x06
  21          #define SEQ_LOCK        0x07
  22          #define SEQ_RTA_rdB5      0x08
  23          #define SEQ_RTA_rdB6      0x09
  24          #define SEQ_RTA_rdB4      0x0a
  25          //#define SEQ_RTA_wrB6      0x0b
  26          #define SEQ_WCMD        0x0C
  27          #define SEQ_RTA_RST       0x0d
  28          
  29          #define SEQ_RTA_STATUS2     0X0f
  30          #define SEQ_RTA_WR        0X10
  31          
  32          
  33          #define SEQ_RTA_KEY2      0x19
  34          #define SEQ_RTA_STATUSout   0x1e
  35          #define SEQ_WAIT_EJECT      0x1F
  36          #define SEQ_SEL_B6w       0x20
  37          
  38          #define SEQ_STATUS_OUT      0x24
  39          #define SEQ_RETRY       0x25
  40          
  41          #define SEQ_RETRY_ANTENA_OFF  0x26
  42          #define SEQ_RETRY_KEY     0x27
  43          
  44          #define SEQ_RETRY_CARD_INSIDE 0X2D
  45          #define SEQ_RTA_STATUS_WR_B6  0X2E
  46          
  47          #define SEQ_RTA_LOADKEY2    0x2f
  48          
  49          #define SEQ_LPR         0x31
  50          
  51          #define SEQ_RTA_SELECT2     0x32
  52          #define SEQ_RTA_STATUS_WR_B5  0X33
  53          #define SEQ_LEE_ID_BACKUP   0x34
  54          #define SEQ_BRTA_ID_BACKUP   0x35
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 2   

  55          #define SEQ_RTA_STATUS_WR_B7  0x36
  56          #define SEQ_RTA_WR_2          0x37
  57          #define SEQ_RETRY_KEY_2       0x38
  58          #define SEQ_RTA_rdB4_Comercio 0x39
  59          //estado de la lectura QR
  60          #define SEQ_QR_WAIT           0x3a
  61          #define SEQ_QR_INICIO         0x3b  
  62          #define SEQ_QR_PTPRL          0x3c
  63          #define SEQ_QR_WCMD           0x3d
  64          #define SEQ_RECARGA_PASSWORD  0x3e
  65          
  66          
  67          //ESTADOR RECEPCION SOFTWARE
  68          
  69          #define ESPERA_RX       0
  70          #define ESPERA_INICIO_RTA   1
  71          #define RX_CONTADOR_H     2
  72          #define RX_CONTADOR_L     3
  73          #define SAVE_STR_SOF      4
  74          #define RX_BCC          5
  75          
  76          #define RX_QR           6
  77          
  78          #define T_WAIT    20
  79          #define TIMConsulta 1200
  80          #define TIMWPoll  100
  81          #define   TIME_RX           200   //
  82          #define CTE_SEG 0X1C        
  83          
  84          #define STX 0x02
  85          #define ETX 0x03
  86          #define CR  0x0d
  87          #define LF  0x0a
  88          #define ACK 0x06
  89          
  90          
  91          #define SIN_ERROR   0x30    // NO ERROR
  92          #define ERR_AUTH    0x31    // ERROR AUTHENTICATION
  93          #define ERR_RD      0x32    // NO SE PUDO LEER INFO
  94          #define ERR_WR      0x33    //
  95          #define ERR_EEPROMK   0x34    // ERROR AL GRABAR EN LECTOR
  96          #define ERR_LECTOR    0x35    // RESPUESTA INCORRECTA DEL LECTOR
  97          #define ERR_EJECT   0x36    // ERROR EN EXPULSAR
  98          #define ERR_APB     0x37    // NO POSEE INGRESO
  99          #define ERR_COD     0x38    // TARJETA NO ES DE ESTE PARQUEADERO
 100          #define DESARM      0x39    // CAJERO DESARMADO / NO PUEDE LIQUIDAR TARJETA DE ROTACION
 101          #define ROTACION    0x3A      // TARJETA DE ROTACION
 102          #define ERR_CARD_TIPO 0X3B      // ERROR TIPO DE TARJETA (STATUS)
 103          #define ERR_COM     0X3c      // ERROR TIPO DE TARJETA (STATUS)
 104          #define CARD_EJECT    0X3D      // ERROR TIPO DE TARJETA (STATUS)
 105          #define CARD_EJECT_WR 0X3E      // ERROR TIPO DE TARJETA (STATUS)
 106          #define ERR_SELECT    0X3F      // ERROR TIPO DE TARJETA (STATUS)
 107          #define ERR_NO_CARD   0X40      // ERROR NO HAY TARJETA PRESENTE
 108          #define ERR_TIME_OUT  0X41      // ERROR NO HAY TARJETA PRESENTE
 109          
 110          #define CARD_INACTIVA   0x00
 111          #define CARD_ROTACION     0x01
 112          #define CARD_MENSUALIDAD  0x02
 113          #define CARD_LOCATARIO    0x05
 114          #define CARD_MULTIPLE   0x0F
 115          #define CARD_COMPARTIDA   0x0A
 116          #define CARD_COMPRA_DCTO  0x0c
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 3   

 117          #define EMITIDA_PERDIDA   0X10
 118          
 119          //ERRORES
 120          #define SELECCION_SECTOR    0
 121          #define COMANDO_WR        1
 122          #define NO_RTA_WR       2
 123          #define COMANDO_RD        3
 124          #define NO_RTA_RD       4
 125          #define FALLA_WR        5
 126          #define NO_CARD         6
 127          
 128          extern unsigned char g_cEstadoComSoft;
 129          extern unsigned int ValTimeOutCom;
 130          extern unsigned char g_cEstadoComSeqMF;
 131          extern unsigned char g_scArrRxComSoft[];
 132          extern unsigned char ID1,ID2,ID3,ID4; 
 133          extern unsigned char centena, decena, unidad;
 134          extern unsigned char TipoCard;
 135          extern unsigned char COD_PARK_R;
 136          extern unsigned char ID_CLIENTE_R;
 137          extern unsigned char xdata buffer_ticket[];
 138          extern  unsigned char xdata sector6[];
 139          extern  unsigned char xdata sector5[];
 140          extern unsigned char Block;
 141          extern const unsigned char ID_CLIENTE;    //          
 142          extern const unsigned char  COD_PARK;
 143          extern unsigned char  num_data;
 144          extern unsigned char xdata g_scDATE[];
 145          extern unsigned char Cod_Dcto;
 146          extern unsigned char TipoVeh;
 147          extern unsigned char Val_Horario;
 148          extern unsigned char Val_PicoPlaca;
 149          extern unsigned char ValDCTO_INPAGO;
 150          extern unsigned char APB_CARD;
 151          extern unsigned char g_scDATE_Liq[];
 152          extern unsigned char TIME_ESPERA;
 153          extern unsigned char NumLiq;
 154          extern  unsigned year, month, day, hour, minut;
 155          extern  unsigned char BufferWrite_MF[];
 156          extern unsigned char RetryWrite_MF[];
 157          extern unsigned char RetryWR;
 158          
 159          extern unsigned char g_cContByteRx;
 160          
 161          
 162          
 163          extern bit buffer_ready;
 164          extern bit Desarmado;
 165          extern bit Permite_Puerta;
 166          extern bit Permite_Monedero;
 167          extern bit Permite_Billetero;
 168          extern bit FueraServicio;
 169          extern  bit EmisionXperdida;
 170          extern bit GrabaTarjeta;
 171          extern bit MultiPark;
 172          extern bit timeOut;
 173          extern bit PrintLPR;
 174          extern bit NotifyCofreB2B;
 175          extern bit NotifyCofreCoin;
 176          extern  bit NotifyPuerta;
 177          extern bit AlarmaPrevia1;
 178          extern bit AlarmaPrevia2;
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 4   

 179          extern bit AlarmaPrevia3;
 180          extern bit alarma1;
 181          extern bit alarma2;
 182          extern bit alarma3;
 183          extern bit onceAlarm;
 184          extern bit ConsultaSoft;
 185          extern bit Expulsa_Grabacion;
 186          extern bit Comparacion;
 187          
 188          extern const bit PuertoMF;
 189          extern const bit PuertoDB9;
 190          extern bit esQR;
 191          
 192          extern void Get_Status(void)  ;
 193          extern void Debug_txt_Tibbo(unsigned char * str);
 194          extern void Select_Card(void);
 195          extern void tx_aux(unsigned char caracter);
 196          extern void Ve_Hex(unsigned char valorhex);
 197          
 198          extern void LoadPass(void);
 199          extern void LoadPass2(void)  ;
 200          extern void Lea_S1_Block(unsigned char Bloque)   ;
 201          extern void Select_S2_Block(unsigned char Bloque) ;
 202          extern void Graba_S1_BloqueSel(unsigned char Bloque)  ;
 203          extern void eject_card ();
 204          extern void Eject_Card(unsigned char CodError);
 205          extern bit Send_Port(unsigned char NumChar);
 206          extern void tx_auxH(unsigned char caracter);
 207          extern void Hex_Str(unsigned char valorhex);
 208          extern unsigned char two_one (unsigned char byte_h,unsigned char byte_l);
 209          extern void posee_in_out();
 210          extern void ve_id(unsigned char id_h,unsigned char id_l);
 211          extern void Debug_Dividir_texto();
 212          extern void recibe_port(void);
 213          extern unsigned char bcd_hex (unsigned char l_data);
 214          extern void ErrorWR(unsigned char TipoERR);
 215          extern void Info_Retry(void);
 216          extern void wait_long (void);
 217          extern void DebugBufferMF(unsigned char *str,unsigned char num_char);
 218          extern unsigned char num_num(unsigned char * p);  
 219          extern unsigned char num_char(unsigned char * p,unsigned char chr); 
 220          //********************************************************************************************************
             -***********************
 221          
 222          /*----------------------------------------------------------------------------------------------------
 223              RECIBE INFORMACION DEL PROCESADOR PRINCIPAL POR P2      
 224          -----------------------------------------------------------------------------------------------------*/
 225          
 226          bit Send_Port(unsigned char NumChar)
 227          {
 228   1          unsigned char j; 
 229   1        long int cont;
 230   1        
 231   1        port_clk=1;             //El que transmite debe fijar primero el Clk en 1
 232   1        rx_in_data=0;           //Led de visualizacion  ON
 233   1        timeOut=0;
 234   1        ready=0;              //Genera interrupcion al Principal
 235   1        cont=50000;
 236   1        while ((busy==1)&&(timeOut==0))   //Espera reconocimiento INT por entrada busy
 237   1        {
 238   2          cont--;
 239   2          if (cont==0)
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 5   

 240   2          {
 241   3            timeOut=1;
 242   3          }
 243   2        }
 244   1        if ((timeOut==0)&&(busy==0))
 245   1        {
 246   2          for (j=0; j<NumChar; j++)
 247   2          {
 248   3            P2=buffer_ticket[j];
 249   3            port_clk=0;
 250   3            wait_long();
 251   3            port_clk=1;
 252   3            wait_long();
 253   3          }
 254   2        }
 255   1        P2=0XFF;
 256   1        ready=1;
 257   1        port_clk=1;
 258   1        rx_in_data=1;         //Led de visualizacion  OFF
 259   1        wait_long();  
 260   1      
 261   1        return timeOut;
 262   1      }
 263          void ProcesoLector(void)
 264          {
 265   1       
 266   1          unsigned char j;
 267   1          unsigned char temp,temp2;
 268   1          unsigned char *tipo_vehiculo;
 269   1          static unsigned char BID1=0,BID2=0,BID3=0,BID4=0,vehiculo,contador_QR=0;
 270   1          static unsigned char Ticket[10];
 271   1          static unsigned char  fecha[17]; 
 272   1          switch (g_cEstadoComSeqMF)
 273   1          {
 274   2      //--------------------------------------------------------------------------------------------------------
             -----------------------*
 275   2            case SEQ_INICIO:                  /*tiempo de espera*/
 276   2              if ((ValTimeOutCom==1)||(buffer_ready==1))
 277   2              {
 278   3                g_cEstadoComSeqMF=SEQ_ESPERA;
 279   3                g_cEstadoComSoft=ESPERA_RX;
 280   3                ValTimeOutCom=T_WAIT;
 281   3                buffer_ready=0;
 282   3              }
 283   2            break;
 284   2      //--------------------------------------------------------------------------------------------------------
             -----------------------*
 285   2            case SEQ_ESPERA:
 286   2      
 287   2              if (ValTimeOutCom==1)
 288   2              {
 289   3                g_cEstadoComSeqMF=SEQ_RTA_STATUS;
 290   3                  Get_Status();                       /*pregunta por el estado del lector*/
 291   3              }
 292   2      
 293   2            break;
 294   2      //--------------------------------------------------------------------------------------------------------
             -----------------------*
 295   2            case SEQ_RTA_STATUS:
 296   2            
 297   2              if (buffer_ready==1)
 298   2              {
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 6   

 299   3                buffer_ready=0;
 300   3                if (g_scArrRxComSoft[5]=='Y')                       /*tenemos presencia de tarjeta en la antena*/
 301   3                {
 302   4                  Debug_txt_Tibbo((unsigned char *) "TARJETA LOCK\r\n");
 303   4                  /*consulto el numero de la serie de la tarjeta*/
 304   4                  Select_Card();                                    
 305   4                  g_cEstadoComSeqMF=SEQ_RTA_SELECT;
 306   4                  Debug_txt_Tibbo(g_scArrRxComSoft);
 307   4                }
 308   3                else
 309   3                {
 310   4                  g_cEstadoComSeqMF=SEQ_ESPERA;                     /*no hay tarjeta probamos si hay QR*/
 311   4                  g_cEstadoComSoft=ESPERA_RX;
 312   4                    ValTimeOutCom=T_WAIT;
 313   4                  /*Debug_txt_Tibbo(g_scArrRxComSoft);          
 314   4                  sel_com=PuertoMF; 
 315   4                  esQR= 1;          
 316   4                  g_cEstadoComSeqMF=SEQ_QR_WAIT;                      /*no hay tarjeta probamos si hay QR*/
 317   4                  //g_cEstadoComSoft=RX_QR;
 318   4                  //ValTimeOutCom=T_WAIT;                                 /*TIME_RX;*/
 319   4                }
 320   3              }
 321   2              else if (ValTimeOutCom==1)
 322   2              { 
 323   3                esQR= 0;  
 324   3                sel_com=PuertoDB9;
 325   3                g_cEstadoComSeqMF=SEQ_ESPERA;
 326   3                g_cEstadoComSoft=ESPERA_RX;
 327   3                ValTimeOutCom=T_WAIT;
 328   3              }
 329   2      
 330   2      
 331   2            break;
 332   2      //--------------------------------------------------------------------------------------------------------
             -----------------------*
 333   2            case SEQ_RTA_SELECT:
 334   2              if (buffer_ready==1)
 335   2              {
 336   3                buffer_ready=0;
 337   3                if (g_scArrRxComSoft[5]=='Y')
 338   3                {
 339   4                  /*Y= tiene el numero de la tarjeta
 340   4                    N= fallo el numero de tarjeta
 341   4                    E= no hay tarjeta
 342   4                  */
 343   4                  ID1=g_scArrRxComSoft[6];                      /*numero de serie de la tarjeta enviado a tcp/ip*/
 344   4                  ID2=g_scArrRxComSoft[7];
 345   4                  ID3=g_scArrRxComSoft[8];
 346   4                  ID4=g_scArrRxComSoft[9];
 347   4      
 348   4                  tx_aux('C');
 349   4                  tx_aux('A');
 350   4                  tx_aux('R');
 351   4                  tx_aux('D');
 352   4                  tx_aux(':');
 353   4                  tx_aux(' ');
 354   4      
 355   4                  Ve_Hex(g_scArrRxComSoft[6]);      // 
 356   4                  tx_aux(decena);
 357   4                  tx_aux(unidad);
 358   4                  tx_aux(' ');
 359   4                  
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 7   

 360   4                  Ve_Hex(g_scArrRxComSoft[7]);      // 
 361   4                  tx_aux(decena);
 362   4                  tx_aux(unidad);
 363   4                  tx_aux(' ');            
 364   4      
 365   4                  Ve_Hex(g_scArrRxComSoft[8]);      // 
 366   4                  tx_aux(decena);
 367   4                  tx_aux(unidad);
 368   4                  tx_aux(' ');
 369   4      
 370   4                  Ve_Hex(g_scArrRxComSoft[9]);      // 
 371   4                  tx_aux(decena);
 372   4                  tx_aux(unidad);
 373   4                    tx_aux(' ');
 374   4      
 375   4                  tx_aux(CR);
 376   4                  tx_aux(LF);                           
 377   4                  
 378   4                  LoadPass();                                     /*envia el password al lector */
 379   4                  g_cEstadoComSeqMF=SEQ_RTA_LOADKEY;
 380   4                  buffer_ready=0;           
 381   4                              
 382   4                }
 383   3                else
 384   3                {
 385   4                  Debug_txt_Tibbo((unsigned char *) "ERROR CARD\r\n");
 386   4                    
 387   4                  Eject_Card(ERR_SELECT);;
 388   4                }
 389   3       
 390   3              }
 391   2              else if (ValTimeOutCom==1)
 392   2              {
 393   3                Debug_txt_Tibbo((unsigned char *) "SIN RTA. SELECT\r\n");
 394   3                Eject_Card(ERR_RD);
 395   3      
 396   3              }
 397   2      
 398   2            break;
 399   2      //--------------------------------------------------------------------------------------------------------
             -----------------------*
 400   2            case SEQ_RTA_LOADKEY:
 401   2      
 402   2              if (buffer_ready==1)
 403   2              {
 404   3                buffer_ready=0;
 405   3                if (g_scArrRxComSoft[6]=='Y')         /*password ok*/
 406   3                {
 407   4                  /*ok password*/
 408   4                  Lea_S1_Block(1);                    /*leo el bloque 1 de la tarjeta MF50*/
 409   4                  g_cEstadoComSeqMF=SEQ_RTA_rdB5;
 410   4                            
 411   4                }
 412   3                else
 413   3                {
 414   4                  Debug_txt_Tibbo((unsigned char *) "ERROR KEY\r\n");
 415   4                  Eject_Card(ERR_AUTH);
 416   4                }
 417   3      
 418   3      
 419   3                }
 420   2              else if (ValTimeOutCom==1)
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 8   

 421   2              {
 422   3                Debug_txt_Tibbo((unsigned char *) "SIN RTA. KEY\r\n");
 423   3                Eject_Card(ERR_AUTH);
 424   3      
 425   3              }
 426   2      
 427   2             break;
 428   2      //--------------------------------------------------------------------------------------------------------
             -----------------------*
 429   2             case SEQ_TEMPORAL:
 430   2      
 431   2              lock=1;
 432   2      
 433   2              break;
 434   2      //--------------------------------------------------------------------------------------------------------
             -----------------------*
 435   2      //--------------------------------------------------------------------------------------------------------
             -----------------------*
 436   2            case SEQ_RTA_rdB5:
 437   2      /*tengo los datos de la tarjeta sector y bloque 16 byte*/
 438   2              if (buffer_ready==1)
 439   2              {
 440   3                buffer_ready=0;
 441   3                if (g_scArrRxComSoft[7]=='Y')         /*lectura ok del bloque 1*/
 442   3                {
 443   4                  //g_scArrRxComSoft[g_cContByteRx]=0;
 444   4                MultiPark=1;
 445   4                  Debug_Dividir_texto() ;       
 446   4                  Debug_txt_Tibbo((unsigned char *) "\r\ntrama del lector tarjetas\r\n");             /*la respuesta es desc
             -onocida*/
 447   4                  DebugBufferMF(g_scArrRxComSoft,g_cContByteRx);                                                          /*imprimo la trama recibi
             -da*/
 448   4                  Debug_txt_Tibbo((unsigned char *) "\r\n");
 449   4                  Debug_Dividir_texto() ; 
 450   4                  
 451   4                  Debug_txt_Tibbo((unsigned char *) "tipo de tarjeta:");
 452   4                  TipoCard=g_scArrRxComSoft[8];
 453   4                  Ve_Hex(TipoCard);
 454   4                    tx_aux(decena);
 455   4                    tx_aux(unidad);
 456   4                    tx_aux(' ');
 457   4                    tx_aux(CR);
 458   4                    tx_aux(LF); 
 459   4                  Debug_Dividir_texto() ; 
 460   4                  Debug_txt_Tibbo((unsigned char *) "ID_CLIENTE_R:");
 461   4                  ID_CLIENTE_R=g_scArrRxComSoft[9];
 462   4                  Ve_Hex(ID_CLIENTE_R);
 463   4                    tx_aux(decena);
 464   4                    tx_aux(unidad);
 465   4                    tx_aux(' ');
 466   4                    tx_aux(CR);
 467   4                    tx_aux(LF); 
 468   4                    Debug_Dividir_texto() ; 
 469   4                    Debug_txt_Tibbo((unsigned char *) "ID_CLIENTE:");
 470   4                    tx_auxH(ID_CLIENTE);
 471   4                    Debug_txt_Tibbo((unsigned char *) "\r\n");
 472   4                    Debug_Dividir_texto() ; 
 473   4                  
 474   4              
 475   4                  Debug_txt_Tibbo((unsigned char *) "COD_PARK_R:");
 476   4                  COD_PARK_R=g_scArrRxComSoft[11];
 477   4                  Ve_Hex(COD_PARK_R);
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 9   

 478   4                    tx_aux(decena);
 479   4                    tx_aux(unidad);
 480   4                    tx_aux(' ');                    
 481   4      
 482   4                  tx_aux(CR);
 483   4                  tx_aux(LF);           
 484   4                  
 485   4                    Debug_Dividir_texto() ; 
 486   4                    Debug_txt_Tibbo((unsigned char *) "COD_PARK:");
 487   4                    tx_auxH(COD_PARK);
 488   4                    Debug_txt_Tibbo((unsigned char *) "\r\n");
 489   4                    Debug_Dividir_texto() ; 
 490   4                  Debug_txt_Tibbo((unsigned char *) "SECTOR1_BLOQUE1: "); 
 491   4                  for (j=0; j<16; j++)                    // GUARDO SECTOR 5 (STATUS CARD, COD PARK. ID PÁRK, FECHA VENCINIENTO
             - MENSUAL)
 492   4                  {
 493   5                    sector5[j]=g_scArrRxComSoft[8+j];
 494   5                    Ve_Hex(g_scArrRxComSoft[8+j]);            // 
 495   5                    tx_aux(decena);
 496   5                    tx_aux(unidad);
 497   5                    tx_aux(' ');
 498   5                  }
 499   4                  tx_aux(CR);
 500   4                  tx_aux(LF); 
 501   4                  
 502   4                  if (((ID_CLIENTE_R==ID_CLIENTE)&&(MultiPark==1))||((ID_CLIENTE_R==ID_CLIENTE)&&(COD_PARK_R==COD_PARK
             -))||((ID_CLIENTE==0)&&(COD_PARK==0)))
 503   4                  {
 504   5                    if ((TipoCard==CARD_ROTACION)||(TipoCard==EMITIDA_PERDIDA)||(TipoCard==CARD_MENSUALIDAD)||(TipoCard
             -==CARD_LOCATARIO))
 505   5                    {
 506   6                      if ((Desarmado==0)&&(FueraServicio==0))
 507   6                      {
 508   7                        if (TipoCard==EMITIDA_PERDIDA)
 509   7                        {
 510   8                          EmisionXperdida=1;
 511   8                        }
 512   7                        else
 513   7                        {
 514   8                          EmisionXperdida=0;
 515   8                        }
 516   7                        g_cEstadoComSeqMF=SEQ_RTA_rdB6;
 517   7                        g_scArrRxComSoft[7]=0xff;
 518   7                        buffer_ready=0;
 519   7      
 520   7                        Block=2;
 521   7                        Lea_S1_Block(Block);            /*se leee el bloque 2 de la tarjeta MF50*/
 522   7      
 523   7                      }
 524   6                      else
 525   6                      {
 526   7                        Debug_txt_Tibbo((unsigned char *) "EN MTO. EJECT\r\n");
 527   7                        
 528   7                        Eject_Card(DESARM);           // Notifica que esta en Mantenimiento. No acepta tarjetas de rotacion
 529   7                      }
 530   6      
 531   6                    }
 532   5      
 533   5                    else if (TipoCard==0x06)            // Tarjeta Servicio Operador
 534   5                    {
 535   6      
 536   6                        if ((Desarmado==0)&&(GrabaTarjeta==0))
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 10  

 537   6                      {
 538   7                        GrabaTarjeta=0;
 539   7                        Permite_Puerta=1;
 540   7                        Permite_Billetero=0;
 541   7                        Permite_Monedero=0;
 542   7                        Desarmado=1;
 543   7                      }
 544   6      
 545   6                      buffer_ticket[0]=STX;               // Inicio de transmision
 546   6                      buffer_ticket[1]='0';               // Dir 0
 547   6                      buffer_ticket[2]=11;                // Dir 0
 548   6                      buffer_ticket[3]='T';               // CMD T=Tarjeta Operativa
 549   6                        buffer_ticket[4]=':';               // CMD L=lectura
 550   6                      buffer_ticket[5]='1';               // 1: Operador
 551   6                      buffer_ticket[6]=ID1;
 552   6                      buffer_ticket[7]=ID2;
 553   6                      buffer_ticket[8]=ID3;
 554   6                      buffer_ticket[9]=ID4;
 555   6                      buffer_ticket[10]=ETX;                // Fin de trasmision
 556   6                      Send_Port(11);                    // ENVIA AL PRINCIPAL
 557   6                      g_cEstadoComSeqMF=SEQ_WCMD;
 558   6                      g_cEstadoComSoft=ESPERA_RX;
 559   6                      ValTimeOutCom=TIMConsulta;
 560   6      
 561   6                    }
 562   5                    else if (TipoCard==0x07)                // Tarjeta Servicio Auditor
 563   5                    {
 564   6      
 565   6                      if((Desarmado==0)&&(GrabaTarjeta==0))
 566   6                      {
 567   7                        GrabaTarjeta=0;
 568   7                        Permite_Puerta=0;
 569   7                        Permite_Billetero=0;
 570   7                        Permite_Monedero=0;
 571   7                          Desarmado=1;
 572   7                      }
 573   6                      buffer_ticket[0]=STX;               // Inicio de transmision
 574   6                      buffer_ticket[1]='0';               // Dir 0
 575   6                      buffer_ticket[2]=11;                // Dir 0
 576   6                      buffer_ticket[3]='T';               // CMD L=lectura
 577   6                        buffer_ticket[4]=':';               // CMD L=lectura
 578   6                      buffer_ticket[5]='2';               // 2: Auditor
 579   6                      buffer_ticket[6]=ID1;
 580   6                      buffer_ticket[7]=ID2;
 581   6                      buffer_ticket[8]=ID3;
 582   6                      buffer_ticket[9]=ID4;
 583   6                      buffer_ticket[10]=ETX;                // Fin de trasmision
 584   6                      Send_Port(11);                    // ENVIA AL PRINCIPAL
 585   6                      g_cEstadoComSeqMF=SEQ_WCMD;
 586   6                      g_cEstadoComSoft=ESPERA_RX;
 587   6                      ValTimeOutCom=TIMConsulta;
 588   6      
 589   6                    }
 590   5                    else if (TipoCard==0x08)                  // Tarjeta Servicio Administrador
 591   5                    {
 592   6                      
 593   6                      if ((Desarmado==0)&&(GrabaTarjeta==0))
 594   6                      {
 595   7                        GrabaTarjeta=0;
 596   7                        Permite_Puerta=1;
 597   7                        Permite_Billetero=1;
 598   7                        Permite_Monedero=1;
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 11  

 599   7                        Desarmado=1;
 600   7                      }
 601   6      
 602   6                      buffer_ticket[0]=STX;               // Inicio de transmision
 603   6                      buffer_ticket[1]='0';               // Dir 0
 604   6                      buffer_ticket[2]=11;                // Dir 0
 605   6                      buffer_ticket[3]='T';               // CMD L=lectura
 606   6                        buffer_ticket[4]=':';               // CMD L=lectura
 607   6                      buffer_ticket[5]='3';               // 3: admin
 608   6                      buffer_ticket[6]=ID1;
 609   6                      buffer_ticket[7]=ID2;
 610   6                      buffer_ticket[8]=ID3;
 611   6                      buffer_ticket[9]=ID4;
 612   6                      buffer_ticket[10]=ETX;                // Fin de trasmision
 613   6                      Send_Port(11);                    // ENVIA AL PRINCIPAL
 614   6                      if  (timeOut==1)
 615   6                      {
 616   7                        Send_Port(0X07);
 617   7                      }
 618   6                      g_cEstadoComSeqMF=SEQ_WCMD;
 619   6                      g_cEstadoComSoft=ESPERA_RX;
 620   6                      ValTimeOutCom=TIMConsulta;
 621   6      
 622   6                    }
 623   5                      
 624   5                    else if ((TipoCard==0xAA)&&(GrabaTarjeta==0))     //&&(Desarmado==0))   // // Tarjeta Servicio Auditor
 625   5                    {
 626   6      
 627   6                      Permite_Puerta=0;
 628   6                      Permite_Billetero=0;
 629   6                      Permite_Monedero=0;
 630   6                      Desarmado=0;
 631   6                      GrabaTarjeta=1;
 632   6                      buffer_ticket[0]=STX;               // Inicio de transmision
 633   6                      buffer_ticket[1]='0';               // Dir 0
 634   6                      buffer_ticket[2]=11;                // Dir 0
 635   6                      buffer_ticket[3]='T';               // CMD L=lectura
 636   6                      buffer_ticket[4]=':';               // CMD L=lectura
 637   6                      buffer_ticket[5]='0';               // 2: Auditor
 638   6                      buffer_ticket[6]=ID1;
 639   6                      buffer_ticket[7]=ID2;
 640   6                      buffer_ticket[8]=ID3;
 641   6                      buffer_ticket[9]=ID4;
 642   6                      buffer_ticket[10]=ETX;                // Fin de trasmision
 643   6                      Send_Port(11);                    // ENVIA AL PRINCIPAL
 644   6                      g_cEstadoComSeqMF=SEQ_WCMD;
 645   6                      g_cEstadoComSoft=ESPERA_RX;
 646   6                      ValTimeOutCom=TIMConsulta;
 647   6                    }
 648   5                    else if ((TipoCard==CARD_COMPRA_DCTO)&&(GrabaTarjeta==0))     //&&(Desarmado==0))   // // Tarjeta Serv
             -icio Auditor
 649   5                    {
 650   6      
 651   6                      if ((Desarmado==0)&&(FueraServicio==0))
 652   6                      {
 653   7                        Debug_txt_Tibbo((unsigned char *) "CARD_COMPRA_DCTO\r\n");
 654   7                        Permite_Puerta=0;
 655   7                        Permite_Billetero=0;
 656   7                        Permite_Monedero=0;
 657   7                        Desarmado=0;
 658   7                        GrabaTarjeta=0;
 659   7                        buffer_ticket[0]=STX;               // Inicio de transmision
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 12  

 660   7                        buffer_ticket[1]='0';               // Dir 0
 661   7                        buffer_ticket[2]=11;                // Dir 0
 662   7                        buffer_ticket[3]='T';               // CMD L=lectura
 663   7                        buffer_ticket[4]=':';               // CMD L=lectura
 664   7                        buffer_ticket[5]='D';               // 2: Auditor
 665   7                        buffer_ticket[6]=ID1;
 666   7                        buffer_ticket[7]=ID2;
 667   7                        buffer_ticket[8]=ID3;
 668   7                        buffer_ticket[9]=ID4;
 669   7                        buffer_ticket[10]=':';                // Fin de trasmision
 670   7                    /*leo el nombre del comercio del descuento*/  
 671   7                        Lea_S1_Block(0);                  // Block(4)
 672   7                        g_cEstadoComSeqMF=SEQ_RTA_rdB4_Comercio;
 673   7                        g_cEstadoComSoft=ESPERA_RX;
 674   7                        ValTimeOutCom=TIMConsulta;
 675   7                        //Send_Port(11);                    // ENVIA AL PRINCIPAL
 676   7                        //g_cEstadoComSeqMF=SEQ_WCMD;
 677   7                        //g_cEstadoComSoft=ESPERA_RX;
 678   7                        //ValTimeOutCom=TIMConsulta;
 679   7        
 680   7                      }
 681   6                      else
 682   6                      {
 683   7                        Debug_txt_Tibbo((unsigned char *) "EN MTO. EJECT\r\n");
 684   7                        
 685   7                        Eject_Card(DESARM);           // Notifica que esta en Mantenimiento. No acepta tarjetas de rotacion
 686   7                      }
 687   6      
 688   6      
 689   6      
 690   6      
 691   6                    }
 692   5                    else
 693   5                    {
 694   6                      
 695   6                      Ve_Hex(TipoCard);
 696   6                      tx_aux(decena);
 697   6                      tx_aux(unidad);
 698   6                      tx_aux(' ');
 699   6                      Eject_Card(ERR_CARD_TIPO);              // No es tarjeta con STATUS valido
 700   6                    }
 701   5      
 702   5                   }
 703   4                  else
 704   4                  {
 705   5                    //OJO REVISAR
 706   5                    Debug_txt_Tibbo((unsigned char *) "ERROR COD. PARK\r\n");
 707   5                    Eject_Card(ERR_COD);
 708   5                  }
 709   4                }
 710   3                else
 711   3                {
 712   4                  Debug_txt_Tibbo((unsigned char *) "SIN RTA. RD B5\r\n");
 713   4                  Eject_Card(ERR_RD);
 714   4              
 715   4                }
 716   3            
 717   3                }
 718   2              else if (ValTimeOutCom==1)
 719   2              {
 720   3                Debug_txt_Tibbo((unsigned char *) "SIN RTA. RD B5\r\n");
 721   3                Eject_Card(ERR_RD);
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 13  

 722   3              }
 723   2            break;
 724   2      //--------------------------------------------------------------------------------------------------------
             -----------------------*
 725   2      //--------------------------------------------------------------------------------------------------------
             -----------------------*
 726   2            case SEQ_RTA_rdB6:
 727   2      
 728   2              if (buffer_ready==1)
 729   2              {
 730   3                buffer_ready=0;
 731   3                  if (g_scArrRxComSoft[7]=='Y')               /*lectura ok del 2 bloque de la memoria MF50*/
 732   3                {
 733   4                  Debug_txt_Tibbo((unsigned char *) "SEQ_RTA_rdB6\r\n");
 734   4                  
 735   4                  Debug_txt_Tibbo((unsigned char *) "SECTOR1_BLOQUE2: ");
 736   4                  for (j=0; j<16; j++)
 737   4                  {
 738   5                    sector6[j]=g_scArrRxComSoft[8+j];
 739   5                    tx_auxH(sector6[j]);        // Envia sector 6 leido
 740   5                  }
 741   4                  tx_aux(CR);
 742   4                  tx_aux(LF);           
 743   4                  
 744   4                  
 745   4                  
 746   4                  if (GrabaTarjeta==1)                  //
 747   4                  {
 748   5      
 749   5                    if (g_scArrRxComSoft[18]==0)            //APB inicializado...Solo Acepta tarjetas formateadas
 750   5                    {
 751   6                      buffer_ticket[0]=STX;             
 752   6                      buffer_ticket[1]='0';             
 753   6                      buffer_ticket[2]=0x08;            
 754   6                      buffer_ticket[3]='U';
 755   6                      buffer_ticket[4]=ID1;
 756   6                      buffer_ticket[5]=ID2;
 757   6                      buffer_ticket[6]=ID3;
 758   6                      buffer_ticket[7]=ID4;
 759   6                      buffer_ticket[8]=ETX;
 760   6                      num_data=9;
 761   6                      Send_Port(num_data);
 762   6                      g_cEstadoComSeqMF=SEQ_WCMD;
 763   6                    
 764   6                    }
 765   5                    else
 766   5                    {
 767   6                      Eject_Card(ROTACION);
 768   6                    } 
 769   5                  }
 770   4                  else
 771   4                  {
 772   5                    if ((g_scArrRxComSoft[18]==1))        // APB 1:Entrada 2:Salida
 773   5                    {
 774   6                      //posee_in_out();
 775   6                      Debug_txt_Tibbo((unsigned char *) "POSEE IN\r\n");
 776   6      
 777   6                    Hex_Str(g_scArrRxComSoft[8]);       // Año Entrada
 778   6                    g_scDATE[0]=decena;
 779   6                    g_scDATE[1]=unidad;
 780   6                      
 781   6                    Hex_Str(g_scArrRxComSoft[9]);       // Mes Entrada
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 14  

 782   6                    g_scDATE[2]=decena;
 783   6                    g_scDATE[3]=unidad;
 784   6                      
 785   6                    Hex_Str(g_scArrRxComSoft[10]);      // Dia Entrada
 786   6                    g_scDATE[4]=decena;
 787   6                    g_scDATE[5]=unidad;
 788   6                      
 789   6                    Hex_Str(g_scArrRxComSoft[11]);      // Hora Entrada
 790   6                    g_scDATE[6]=decena;
 791   6                    g_scDATE[7]=unidad;
 792   6                                    
 793   6                    Hex_Str(g_scArrRxComSoft[12]);      // Minuto Entrada
 794   6                    g_scDATE[8]=decena;
 795   6                    g_scDATE[9]=unidad;
 796   6        
 797   6                    Cod_Dcto=two_one(g_scArrRxComSoft[15],g_scArrRxComSoft[14]);
 798   6                    Cod_Dcto=Cod_Dcto+0x30;
 799   6                      
 800   6                    Debug_txt_Tibbo((unsigned char *) "DCTO:");
 801   6                    tx_aux(Cod_Dcto);
 802   6                    tx_aux(CR);
 803   6                    tx_aux(LF);
 804   6      
 805   6      //------------------------------------------------------------------------------------------------
 806   6                    TipoVeh=g_scArrRxComSoft[16]&(0x0f);
 807   6                    Val_Horario=g_scArrRxComSoft[16]&(0xf0);
 808   6                    Val_Horario>>=4;
 809   6      //------------------------------------------------------------------------------------------------
 810   6                if ((TipoCard==CARD_MENSUALIDAD)||(TipoCard==CARD_COMPARTIDA))
 811   6                {
 812   7                  Val_PicoPlaca=g_scArrRxComSoft[17]&0xf0;
 813   7                  Val_PicoPlaca>>=4;
 814   7                  ValDCTO_INPAGO=g_scArrRxComSoft[17]&0x0F;
 815   7               }
 816   6              else
 817   6              {
 818   7                ValDCTO_INPAGO=g_scArrRxComSoft[17];
 819   7              }
 820   6      
 821   6                APB_CARD=g_scArrRxComSoft[18];
 822   6      //------------------------------------------------------------------------------------------------
 823   6              Hex_Str(g_scArrRxComSoft[19]);      // Año Liquidacion + T gracia
 824   6              g_scDATE_Liq[0]=decena;
 825   6              g_scDATE_Liq[1]=unidad;
 826   6                      
 827   6              Hex_Str(g_scArrRxComSoft[20]);      // Mes Liquidacion + T gracia
 828   6              g_scDATE_Liq[2]=decena;
 829   6              g_scDATE_Liq[3]=unidad;
 830   6                      
 831   6              Hex_Str(g_scArrRxComSoft[21]);      // Dia Liquidacion + T gracia
 832   6              g_scDATE_Liq[4]=decena;
 833   6              g_scDATE_Liq[5]=unidad;
 834   6                    
 835   6              Hex_Str(g_scArrRxComSoft[22]);      // Hora Liquidacion + T gracia
 836   6              g_scDATE_Liq[6]=decena;
 837   6              g_scDATE_Liq[7]=unidad;
 838   6                
 839   6              Hex_Str(g_scArrRxComSoft[23]);      // Minuto Liquidacion + T gracia
 840   6              g_scDATE_Liq[8]=decena;
 841   6              g_scDATE_Liq[9]=unidad;
 842   6      //------------------------------------------------------------------------------------------------                
 843   6                              
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 15  

 844   6              Lea_S1_Block(0);                  /* lee el bloque 0 de la tarjeta MF50 */
 845   6              g_cEstadoComSeqMF=SEQ_RTA_rdB4;
 846   6                      
 847   6      //-----------------------------------------------------------------------------------------------
 848   6                    
 849   6      
 850   6                    }
 851   5                    else if  ((g_scArrRxComSoft[18]==2)&&((TipoCard==CARD_MENSUALIDAD)||(TipoCard==CARD_LOCATARIO)))
 852   5                    {
 853   6                      Debug_txt_Tibbo((unsigned char *) "MENSUAL NO POSEE IN OPCION RENOVAR\r\n");
 854   6                        
 855   6                      g_scDATE[0]='0';            // Año Entrada
 856   6                      g_scDATE[1]='0';
 857   6                      
 858   6          
 859   6                      g_scDATE[2]='0';            // Mes Entrada
 860   6                      g_scDATE[3]='0';
 861   6                      
 862   6          
 863   6                      g_scDATE[4]='0';              // Dia Entrada
 864   6                      g_scDATE[5]='0';
 865   6                      
 866   6          
 867   6                      g_scDATE[6]='0';            // Hora Entrada
 868   6                      g_scDATE[7]='0';
 869   6                                    
 870   6        
 871   6                      g_scDATE[8]='0';            // Minuto Entrada
 872   6                      g_scDATE[9]='0';
 873   6        
 874   6                      Cod_Dcto='0';
 875   6      
 876   6      //------------------------------------------------------------------------------------------------
 877   6                      TipoVeh=g_scArrRxComSoft[16]&(0x0f);
 878   6                      Val_Horario=g_scArrRxComSoft[16]&(0xf0);
 879   6                      Val_Horario>>=4;
 880   6      //------------------------------------------------------------------------------------------------
 881   6      
 882   6                      Val_PicoPlaca=g_scArrRxComSoft[17]&0xf0;
 883   6                      Val_PicoPlaca>>=4;
 884   6                      ValDCTO_INPAGO=g_scArrRxComSoft[17]&0x0F;
 885   6      
 886   6      
 887   6                      APB_CARD=g_scArrRxComSoft[18];
 888   6      //------------------------------------------------------------------------------------------------
 889   6        
 890   6                      g_scDATE_Liq[0]='0';           // Año Liquidacion + T gracia
 891   6                      g_scDATE_Liq[1]='0';
 892   6                      
 893   6            
 894   6                      g_scDATE_Liq[2]='0';           // Mes Liquidacion + T gracia
 895   6                      g_scDATE_Liq[3]='0';
 896   6                      
 897   6          
 898   6                      g_scDATE_Liq[4]='0';           // Dia Liquidacion + T gracia
 899   6                      g_scDATE_Liq[5]='0';
 900   6                      
 901   6          
 902   6                      g_scDATE_Liq[6]='0';           // Hora Liquidacion + T gracia
 903   6                      g_scDATE_Liq[7]='0';
 904   6                  
 905   6          
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 16  

 906   6                      g_scDATE_Liq[8]='0';          // Minuto Liquidacion + T gracia
 907   6                      g_scDATE_Liq[9]='0';
 908   6      
 909   6                      Lea_S1_Block(0);            // Block(4)
 910   6                      g_cEstadoComSeqMF=SEQ_RTA_rdB4;
 911   6      
 912   6      
 913   6      
 914   6                    }
 915   5                    else
 916   5                    {
 917   6                      
 918   6                        Debug_txt_Tibbo((unsigned char *) "SIN INGRESO\r\n");
 919   6                        posee_in_out();                   /*modificacion jp*/             
 920   6                      //  Eject_Card(ERR_APB);
 921   6      
 922   6      
 923   6      
 924   6      
 925   6      
 926   6                    }
 927   5                  }
 928   4                }
 929   3                else
 930   3                {
 931   4                  Eject_Card(ERR_LECTOR);
 932   4                }
 933   3      
 934   3                buffer_ready=0;
 935   3                g_cEstadoComSoft=ESPERA_RX;
 936   3                ValTimeOutCom=TIMWPoll;           
 937   3                }
 938   2              else if (ValTimeOutCom==1)
 939   2              {
 940   3                Debug_txt_Tibbo((unsigned char *) "SIN RTA. RD B6\r\n");
 941   3                Eject_Card(ERR_RD);
 942   3              }
 943   2      
 944   2            break;
 945   2      //--------------------------------------------------------------------------------------------------------
             -----------------------*
 946   2      //--------------------------------------------------------------------------------------------------------
             -----------------------*
 947   2        case SEQ_RTA_rdB4_Comercio:
 948   2      
 949   2              if ((buffer_ready==1)||(ValTimeOutCom==1))
 950   2              {
 951   3                  
 952   3                if (g_scArrRxComSoft[7]=='Y')
 953   3                {
 954   4                  Debug_txt_Tibbo((unsigned char *) "SECTOR1_BLOQUE0: ");
 955   4                  //for (j=0; j<16; j++)
 956   4                  //{
 957   4                  //  tx_auxH(g_scArrRxComSoft[8+j]);       // Envia sector 6 leido
 958   4                //  }
 959   4                //  tx_aux(CR);
 960   4                //  tx_aux(LF);   
 961   4                  
 962   4                  for (j=0; j<16; j++)
 963   4                  {
 964   5                    buffer_ticket[j+11]=g_scArrRxComSoft[8+j];
 965   5                  } 
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 17  

 966   4      
 967   4                }
 968   3                else
 969   3                {
 970   4                  for (j=11; j<27; j++)
 971   4                  {
 972   5                    buffer_ticket[j]=' ';
 973   5                  }
 974   4        
 975   4                }
 976   3                buffer_ticket[27]=ETX;
 977   3                
 978   3                for (j=0; j<28; j++)
 979   3                {
 980   4                    tx_aux(buffer_ticket[j]);
 981   4                }
 982   3                tx_aux(CR);
 983   3                tx_aux(LF);           
 984   3                
 985   3                Send_Port(28);                    // ENVIA AL PRINCIPAL
 986   3                g_cEstadoComSeqMF=SEQ_WCMD;
 987   3                g_cEstadoComSoft=ESPERA_RX;
 988   3                ValTimeOutCom=TIMConsulta;
 989   3                TIME_ESPERA=CTE_SEG*300;
 990   3      
 991   3      
 992   3              }
 993   2       
 994   2            break;    
 995   2      
 996   2      
 997   2            case SEQ_RTA_rdB4:
 998   2      
 999   2              if ((buffer_ready==1)||(TipoCard==CARD_MENSUALIDAD))
1000   2              {
1001   3                Debug_txt_Tibbo((unsigned char *) "SEQ_RTA_rdB4\n");
1002   3                
1003   3                if ((g_scArrRxComSoft[7]=='Y')||(TipoCard==CARD_MENSUALIDAD))   /*lectura del bloque 0 ok*/
1004   3                {
1005   4      
1006   4      
1007   4                  buffer_ready=0;
1008   4      
1009   4                  buffer_ticket[0]=STX;               // Inicio de transmision
1010   4                  buffer_ticket[1]='0';               // Dir 0
1011   4                  buffer_ticket[3]='L';               // CMD L=lectura
1012   4                  num_data=4;                         // Posicion 2 = Numero de Caracteres enviados
1013   4      
1014   4                  if ((TipoCard==CARD_MENSUALIDAD)||(TipoCard==CARD_LOCATARIO))
1015   4                  {
1016   5                    /*COVIERTE ID A DECIMAL*/
1017   5                    ve_id(ID2,ID1);
1018   5                  }
1019   4                  else
1020   4                  {
1021   5      
1022   5                    for (j=0; g_scArrRxComSoft[8+j]!='\0'; j++)     // Código hasta encontrar NULL
1023   5                    {
1024   6                      buffer_ticket[num_data++]=g_scArrRxComSoft[8+j];
1025   6                    }
1026   5                  }
1027   4                  
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 18  

1028   4                  /*datos de la memoria*/
1029   4                  buffer_ticket[num_data++]=':';
1030   4                  for (j=0; j<10; j++)                // Fecha De Entrada
1031   4                  {
1032   5                    buffer_ticket[num_data++]=g_scDATE[j];
1033   5                  }
1034   4                  buffer_ticket[num_data++]=':';
1035   4                  
1036   4                  if (TipoVeh==0x00)                  // Moto / Carro
1037   4                  {
1038   5                    buffer_ticket[num_data++]='C';            // Carro=0
1039   5                  }
1040   4                  else if (TipoVeh==0x01)
1041   4                  {
1042   5                    buffer_ticket[num_data++]='M';          // Moto=1
1043   5                  }
1044   4                  else if (TipoVeh==0x02)
1045   4                  {
1046   5                    buffer_ticket[num_data++]='B';          // Bicicleta=2
1047   5                  }
1048   4                  else if (TipoVeh==0x03)
1049   4                  {
1050   5                    buffer_ticket[num_data++]='T';          // Camion=3
1051   5                  }
1052   4                  else
1053   4                  {
1054   5                    buffer_ticket[num_data++]='C';
1055   5                  }
1056   4      
1057   4                  buffer_ticket[num_data++]=':';
1058   4      //-------------------------------------------------------------------------------//
1059   4      //            if (EmisionXperdida==1)
1060   4      //            {
1061   4      //              Cod_Dcto='0';
1062   4      //              EmisionXperdida=0;
1063   4      //            }
1064   4      //-------------------------------------------------------------------------------//           
1065   4                  buffer_ticket[num_data++]=Cod_Dcto;
1066   4                  buffer_ticket[num_data++]=':';
1067   4      //------------------------------------------------------------------------------// Fecha Liquidacion
1068   4                  for (j=0; j<10; j++)            
1069   4                  {
1070   5                    buffer_ticket[num_data++]=g_scDATE_Liq[j];
1071   5                  }
1072   4                  buffer_ticket[num_data++]=':';
1073   4      //------------------------------------------------------------------------------//
1074   4                  if (TipoCard!=EMITIDA_PERDIDA)
1075   4                  {
1076   5                      buffer_ticket[num_data++]=TipoCard+0X30;      // Tipo de tarjeta 1=Rotacion Normal
1077   5                  }
1078   4                  else
1079   4                  {
1080   5                    
1081   5                    buffer_ticket[num_data++]='P';            // Tipo de tarjeta Perdida
1082   5                  }
1083   4                  buffer_ticket[num_data++]=':';
1084   4      //------------------------------------------------------------------------------//  LPR             
1085   4                  if ((PrintLPR==1)&&(TipoCard!=CARD_MENSUALIDAD)&&(TipoCard!=CARD_COMPARTIDA)&&(TipoCard!=CARD_MULTIP
             -LE))
1086   4                  {
1087   5                    Debug_txt_Tibbo((unsigned char *) "KEY2\r\n");
1088   5                      
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 19  

1089   5                      LoadPass2();                              /*envia la clave 2 a la tarjeta mf50*/
1090   5                      g_cEstadoComSeqMF=SEQ_RTA_KEY2; 
1091   5                      
1092   5                  }
1093   4                  else
1094   4                  {
1095   5                    buffer_ticket[num_data++]=' ';
1096   5                      buffer_ticket[num_data++]=':';
1097   5      //------------------------------------------------------------------------------//
1098   5                    buffer_ticket[num_data++]=ETX;            // Fin de trasmision
1099   5                  
1100   5                    buffer_ticket[2]=num_data;              // Numero de datos (Despues de DIR antes de Comando)
1101   5      //------------------------------------------------------------------------------//              
1102   5      //              sel_com=PuertoMF;                 // Datos enviados ap Principal
1103   5      //              for (j=num_datos-9; j<num_datos+1; j++)
1104   5      //              {
1105   5      //                tx_chr(buffer_ticket[j]);
1106   5      //              }
1107   5      //              tx_chr(CR);
1108   5      //              tx_chr(LF);
1109   5      //              while (sendactive==1) 
1110   5      //              {
1111   5      //              }
1112   5      //              sel_com=PuertDB9;
1113   5      //------------------------------------------------------------------------------//                    
1114   5                    for (j=0; j<num_data; j++)
1115   5                    {
1116   6                      tx_aux(buffer_ticket[j]);
1117   6                    }
1118   5                    tx_aux(CR);
1119   5                    tx_aux(LF);
1120   5      
1121   5      //------------------------------------------------------------------------------//              
1122   5                    Send_Port(num_data);                // ENVIA AL PRINCIPAL
1123   5                    if  (timeOut==1)
1124   5                    {
1125   6                      Send_Port(num_data);
1126   6                    }
1127   5                      g_cEstadoComSeqMF=SEQ_WCMD;
1128   5                    TIME_ESPERA=CTE_SEG*30;             //6
1129   5      
1130   5                  }
1131   4                }
1132   3                else
1133   3                 {
1134   4                  Eject_Card(ERR_LECTOR);
1135   4                }
1136   3      
1137   3                buffer_ready=0; 
1138   3                g_cEstadoComSoft=ESPERA_RX;
1139   3                ValTimeOutCom=TIMWPoll;                 
1140   3                }
1141   2              else if (ValTimeOutCom==1)
1142   2              {
1143   3                Debug_txt_Tibbo((unsigned char *) "SIN RTA. RD B4\r\n");
1144   3                Eject_Card(ERR_RD);
1145   3              }
1146   2      
1147   2      
1148   2            break;
1149   2      //--------------------------------------------------------------------------------------------------------
             -----------------------*
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 20  

1150   2             case SEQ_RTA_KEY2:
1151   2        
1152   2            if ((ValTimeOutCom==1)||(buffer_ready==1))
1153   2            {
1154   3              if ((buffer_ready==1)&&(g_scArrRxComSoft[6]=='Y'))  /*clave ok en el lector*/
1155   3              {
1156   4                Debug_txt_Tibbo((unsigned char *) "RD LPR\r\n");
1157   4                buffer_ready=0;
1158   4                Select_S2_Block(0);                                 /*leo el contenido de la informacion en MF50 del mensual q esta e
             -n el sector2 bloque 0*/
1159   4                g_cEstadoComSeqMF=SEQ_LPR;
1160   4                //lee sector 2 bloque 0 : PLACA
1161   4      
1162   4              }
1163   3              else
1164   3              {
1165   4                buffer_ticket[num_data++]=' ';
1166   4                buffer_ticket[num_data++]=':';
1167   4                buffer_ticket[num_data++]=ETX;                // Fin de trasmision
1168   4                buffer_ticket[2]=num_data;
1169   4      //------------------------------------------------------------------------------//                    
1170   4                for (j=0; j<num_data; j++)
1171   4                {
1172   5                  tx_aux(buffer_ticket[j]);
1173   5                }
1174   4                tx_aux(CR);
1175   4                tx_aux(LF);
1176   4      //------------------------------------------------------------------------------//              
1177   4                Send_Port(num_data);                  // ENVIA AL PRINCIPAL
1178   4                if  (timeOut==1)
1179   4                {
1180   5                  Send_Port(num_data);
1181   5                }
1182   4                  g_cEstadoComSeqMF=SEQ_WCMD;
1183   4              }
1184   3            }
1185   2      
1186   2             break;
1187   2      //--------------------------------------------------------------------------------------------------------
             ---------------------*
1188   2      //--------------------------------------------------------------------------------------------------------
             -----------------------*
1189   2            case SEQ_LPR:
1190   2      
1191   2              if ((ValTimeOutCom==1)||(buffer_ready==1))
1192   2              {
1193   3                if ((buffer_ready==1)&&(g_scArrRxComSoft[7]=='Y'))
1194   3                {
1195   4                  Debug_txt_Tibbo((unsigned char *) "PLACA:");
1196   4                  
1197   4                        
1198   4                  buffer_ready=0;
1199   4                  for (j=0; g_scArrRxComSoft[8+j]!='\0'; j++)       // cargo el arreglo  para transmitirlo al pto paralel
             -o la placa
1200   4                  {
1201   5                    buffer_ticket[num_data++]=g_scArrRxComSoft[8+j];
1202   5                    tx_aux(g_scArrRxComSoft[8+j]);
1203   5                  }
1204   4      
1205   4                  NumLiq = g_scArrRxComSoft[23];
1206   4      
1207   4                  tx_aux(CR);
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 21  

1208   4                  tx_aux(LF);
1209   4                }
1210   3                else                            // No hubo lectura sector LPR
1211   3                {
1212   4                  buffer_ticket[num_data++]=' ';
1213   4                }
1214   3                buffer_ticket[num_data++]=':';
1215   3                buffer_ticket[num_data++]=ETX;                // Fin de trasmision
1216   3                buffer_ticket[2]=num_data;                  // Numero de datos (Despues de DIR antes de Comando)
1217   3      //------------------------------------------------------------------------------//              
1218   3      //          sel_com=PuertoMF;                     // Datos enviados ap Principal
1219   3      //          for (j=num_datos-9; j<num_datos+1; j++)
1220   3      //          {
1221   3      //            tx_chr(buffer_ticket[j]);
1222   3      //          }
1223   3      //          tx_chr(CR);
1224   3      //          tx_chr(LF);
1225   3      //          while (sendactive==1) 
1226   3      //          {
1227   3      //          }
1228   3      //          sel_com=PuertDB9;
1229   3      //------------------------------------------------------------------------------//                    
1230   3                Debug_Dividir_texto();        
1231   3                Debug_txt_Tibbo((unsigned char *) "Comunicacion pto paralelo\d\n");
1232   3                for (j=0; j<num_data; j++)
1233   3                {
1234   4                  tx_aux(buffer_ticket[j]);
1235   4                }
1236   3                tx_aux(CR);
1237   3                tx_aux(LF);
1238   3                Debug_Dividir_texto();
1239   3                
1240   3      //------------------------------------------------------------------------------//              
1241   3                Send_Port(num_data);                    // ENVIA AL PRINCIPAL
1242   3                if  (timeOut==1)
1243   3                {
1244   4                  Send_Port(num_data);
1245   4                }
1246   3                  TIME_ESPERA=CTE_SEG*30;       /*el tiempo era 6 */
1247   3                  g_cEstadoComSeqMF=SEQ_WCMD;
1248   3        
1249   3               }
1250   2      
1251   2            break;
1252   2      //--------------------------------------------------------------------------------------------------------
             -----------------------*
1253   2            case SEQ_RTA_EJECT:
1254   2              if ((ValTimeOutCom==1)||(buffer_ready==1))
1255   2              {
1256   3                ValTimeOutCom=TIMWPoll;
1257   3                buffer_ready=0;
1258   3      
1259   3                g_cEstadoComSeqMF=SEQ_ESPERA;
1260   3                g_cEstadoComSoft=ESPERA_RX;
1261   3                ValTimeOutCom=T_WAIT;
1262   3                }
1263   2            break;
1264   2      
1265   2      //--------------------------------------------------------------------------------------------------------
             -----------------------*
1266   2            case SEQ_STATUS_OUT:
1267   2      
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 22  

1268   2              if (ValTimeOutCom==1)
1269   2              {
1270   3                Get_Status();
1271   3                g_cEstadoComSeqMF=SEQ_RTA_STATUSout;
1272   3                buffer_ready=0;
1273   3                g_cEstadoComSoft=ESPERA_RX;
1274   3                ValTimeOutCom=TIMWPoll;       
1275   3      
1276   3                }
1277   2            break;
1278   2      //--------------------------------------------------------------------------------------------------------
             -----------------------*
1279   2            case SEQ_RTA_STATUSout:
1280   2              if ((ValTimeOutCom==1)||(buffer_ready==1))
1281   2              {
1282   3                if ((buffer_ready==1)&&(g_scArrRxComSoft[3]=='P'))
1283   3                {
1284   4                  if (busy==0)
1285   4                  {
1286   5                    recibe_port();
1287   5            
1288   5                    if (buffer_ticket[3]=='?')
1289   5                    {
1290   6                      buffer_ticket[0]=STX;
1291   6                      buffer_ticket[1]='0';
1292   6                      buffer_ticket[2]=0x06;
1293   6                      buffer_ticket[3]='?';
1294   6                      buffer_ticket[4]=ACK;
1295   6                      buffer_ticket[5]=ETX;
1296   6                      Send_Port(6);         
1297   6                      }
1298   5                    else if (buffer_ticket[3]=='o')
1299   5                    {
1300   6                      GrabaTarjeta=0;
1301   6                      Desarmado=0;
1302   6                      Permite_Puerta=0;
1303   6                      Permite_Billetero=0;
1304   6                      Permite_Monedero=0;
1305   6                      NotifyCofreCoin=0;
1306   6                      NotifyCofreB2B=0;
1307   6                      NotifyPuerta=0;
1308   6                      }
1309   5                    else if (buffer_ticket[3]=='F')
1310   5                    {
1311   6                      FueraServicio=1;
1312   6                      }
1313   5                    else if (buffer_ticket[3]=='E')
1314   5                    {
1315   6                      FueraServicio=0;
1316   6                      AlarmaPrevia1=0;
1317   6                      AlarmaPrevia2=0;
1318   6                      AlarmaPrevia3=0;
1319   6                      GrabaTarjeta=0;
1320   6                      Desarmado=0;
1321   6                      lock=0;
1322   6                      onceAlarm=0;
1323   6                      alarma1=0;
1324   6                      alarma2=0;
1325   6                      alarma3=0;
1326   6                      Permite_Puerta=0;
1327   6                      Permite_Billetero=0;
1328   6                      Permite_Monedero=0;
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 23  

1329   6                      NotifyCofreCoin=0;
1330   6                      NotifyCofreB2B=0;
1331   6                      NotifyPuerta=0;
1332   6                      }
1333   5      
1334   5                  }
1335   4      
1336   4                  Get_Status();
1337   4                  g_cEstadoComSeqMF=SEQ_RTA_STATUSout;
1338   4                }
1339   3                else
1340   3                {
1341   4                  g_cEstadoComSeqMF=SEQ_INICIO;
1342   4      
1343   4                }
1344   3                buffer_ready=0;
1345   3                g_cEstadoComSoft=ESPERA_RX;
1346   3                ValTimeOutCom=TIMWPoll;
1347   3                }
1348   2      
1349   2            break;
1350   2      //--------------------------------------------------------------------------------------------------------
             -----------------------*
1351   2      //--------------------------------------------------------------------------------------------------------
             -----------------------*
1352   2            case SEQ_WCMD:
1353   2              
1354   2                if (TIME_ESPERA==1)
1355   2              {
1356   3                    Eject_Card(ERR_TIME_OUT);
1357   3                
1358   3      //-------------------------------------------------------------------------------------------*
1359   3                    Debug_txt_Tibbo((unsigned char *) "EXPULSA TIME OUT\r\n");
1360   3                
1361   3      //-------------------------------------------------------------------------------------------*          
1362   3      
1363   3              }
1364   2      
1365   2              else if (busy==0)                                       /*recive informacion pto paralelo*/
1366   2              {
1367   3                recibe_port();
1368   3      
1369   3                if ((buffer_ticket[0]==ACK)&&(num_data==1))
1370   3                {
1371   4                  TIME_ESPERA=0;
1372   4      
1373   4                }
1374   3      
1375   3      //-------------------------------------------------------------------------------------------*
1376   3        
1377   3                if (buffer_ticket[3]=='O')        //eject
1378   3                {
1379   4                  TIME_ESPERA=0;
1380   4      //-------------------------------------------------------------------------------------------*
1381   4                  /*solo ejecta MF*/
1382   4                  if (num_data==5)                
1383   4                  {
1384   5                      if (Desarmado==1)
1385   5                    {
1386   6                      Eject_Card(DESARM);
1387   6                    }
1388   5                    else
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 24  

1389   5                    {
1390   6                      Eject_Card(CARD_EJECT);
1391   6                    }
1392   5      
1393   5                    tx_aux('P');
1394   5                    tx_aux('C');
1395   5                    tx_aux(':');
1396   5                    for (j=0; j<5; j++)
1397   5                    {
1398   6                      tx_aux(buffer_ticket[j]); 
1399   6                    }
1400   5                    
1401   5                    Debug_txt_Tibbo((unsigned char *) "\r\nEXPULSA\r\n");
1402   5                    
1403   5                    for (j=0; j<60; j++)
1404   5                    {
1405   6                      buffer_ticket[j]=0;
1406   6                    }
1407   5      //-------------------------------------------------------------------------------------------*
1408   5                  }
1409   4                  else if (num_data>=16)
1410   4                  {
1411   5        
1412   5      //-------------------------------------------------------------------------------------------*
1413   5                    Debug_txt_Tibbo((unsigned char *) "\r\nPC: comunicacion pto paralelo eject con fecha out\r\n");
1414   5                    Debug_Dividir_texto();
1415   5                    /*trama pto paralelo a tcp debuger*/
1416   5                    for (j=0; j<num_data; j++)
1417   5                    {
1418   6                      tx_aux(buffer_ticket[j]); 
1419   6                    }
1420   5                    tx_aux(0X0d);
1421   5                    tx_aux(0X0a);
1422   5                    Debug_Dividir_texto();
1423   5      //-------------------------------------------------------------------------------------------*
1424   5                    if (buffer_ticket[3]=='O')
1425   5                    {
1426   6                      year=two_one(buffer_ticket[5],buffer_ticket[6]);
1427   6                      year=bcd_hex(year);
1428   6                     
1429   6                      month=two_one(buffer_ticket[7],buffer_ticket[8]);
1430   6                      month=bcd_hex(month);
1431   6        
1432   6                      day=two_one(buffer_ticket[9],buffer_ticket[10]);
1433   6                      day=bcd_hex(day);
1434   6                     
1435   6                      hour=two_one(buffer_ticket[11],buffer_ticket[12]);
1436   6                      hour=bcd_hex(hour);
1437   6        
1438   6                      minut=two_one(buffer_ticket[13],buffer_ticket[14]);
1439   6                      minut=bcd_hex(minut);
1440   6        
1441   6                      sector6[9]=ValDCTO_INPAGO|0x0f;     // Niblle Bajo == f (xxxx1111)  Pago proviene de Cajero
1442   6                      
1443   6                      sector6[11]=year;
1444   6                        sector6[12]=month;
1445   6                      sector6[13]=day;
1446   6                        sector6[14]=hour;
1447   6                      sector6[15]=minut;
1448   6        
1449   6      
1450   6      //--------------------------------------------------------------------------------------------------
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 25  

1451   6                      Debug_txt_Tibbo((unsigned char *) "\r\nDatos MF \r\n");           
1452   6                      Debug_Dividir_texto();
1453   6                      /*informacion de la tarjeta mf50*/
1454   6                      for (j=0; j<16; j++)
1455   6                      {
1456   7                        BufferWrite_MF[j]=sector6[j];
1457   7                        tx_auxH(BufferWrite_MF[j]);        // Envia sector 6 a BufferWrite_MF para grabar  !NO COMENTARIAR
1458   7                      }
1459   6                      tx_aux(CR);
1460   6                      tx_aux(LF);
1461   6                      Debug_Dividir_texto();
1462   6      //--------------------------------------------------------------------------------------------------
1463   6                      for (j=0; j<16; j++)              // Reintento
1464   6                      {
1465   7                        RetryWrite_MF[j]=sector6[j];
1466   7                      }         
1467   6      
1468   6                      ValTimeOutCom=500;  
1469   6                      if (sector5[0]!=EMITIDA_PERDIDA )         /*preguntamos si la tarjeta esta perdida*/
1470   6                      {
1471   7                        Debug_txt_Tibbo((unsigned char *) "\r\nWR_MF SEQ_RTA_STATUS_WR_B6: \r\n");
1472   7                        Block=2;                                /*graba fecha de salida*/
1473   7                        Get_Status();
1474   7                        buffer_ready=0;
1475   7                        g_cEstadoComSeqMF=SEQ_RTA_STATUS_WR_B6; 
1476   7                      }
1477   6                      else
1478   6                      {
1479   7                                      
1480   7                        Debug_txt_Tibbo((unsigned char *) "\r\nWR_MF SEQ_RTA_STATUS_WR_B6_PeRdiDa_RTCN: \r\n");
1481   7                        sector5[0]=01;                          /*modifica el estado de perdida a rotacion*/                    
1482   7                        /*se muestra bloque1 sector1 informacion*/
1483   7                        for (j=0; j<16; j++)
1484   7                        {
1485   8                        BufferWrite_MF[j]=sector5[j];
1486   8                        tx_auxH(BufferWrite_MF[j]);        // Envia sector 6 a BufferWrite_MF para grabar  !NO COMENTARIAR
1487   8                        }
1488   7                        tx_aux(CR);
1489   7                        tx_aux(LF);
1490   7                        Debug_Dividir_texto();
1491   7      //--------------------------------------------------------------------------------------------------
1492   7                        for (j=0; j<16; j++)              // Reintento
1493   7                        {
1494   8                        RetryWrite_MF[j]=sector5[j];
1495   8                        }         
1496   7                        
1497   7                        TIME_ESPERA=0;
1498   7                        Block=1;
1499   7                        /*graba la informacion del tipo de tarjeta sector1_bloque 1*/
1500   7                        //Graba_S1_BloqueSel(Block);
1501   7                        /*para saber si esta la tarjeta*/
1502   7                        Get_Status();
1503   7                        buffer_ready=0;
1504   7                        g_cEstadoComSeqMF=SEQ_RECARGA_PASSWORD;    //SEQ_RTA_STATUS_WR_B7;     //SEQ_RTA_WR_2;
1505   7                        break;
1506   7                      }
1507   6                              /**/
1508   6      //--------------------------------------------------------------------------------------------------
1509   6                    }
1510   5                    else if (buffer_ticket[3]=='M')
1511   5                    {
1512   6                        
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 26  

1513   6                        year=two_one(buffer_ticket[5],buffer_ticket[6]);            // FECHA DE VENCIMIENTO
1514   6                      year=bcd_hex(year);
1515   6                     
1516   6                      month=two_one(buffer_ticket[7],buffer_ticket[8]);
1517   6                      month=bcd_hex(month);
1518   6        
1519   6                      day=two_one(buffer_ticket[9],buffer_ticket[10]);
1520   6                      day=bcd_hex(day);
1521   6                     
1522   6                      sector5[8]=year;
1523   6                      sector5[9]=month;
1524   6                      sector5[10]=day;
1525   6      //--------------------------------------------------------------------------------------------------
1526   6                      Debug_Dividir_texto();
1527   6                      Debug_txt_Tibbo((unsigned char *) "WR VENCIMIENTO:SEQ_RTA_STATUS_WR_B5 ");              
1528   6      
1529   6                        
1530   6                      for (j=0; j<16; j++)
1531   6                      {
1532   7                        BufferWrite_MF[j]=sector5[j];
1533   7                        tx_auxH(BufferWrite_MF[j]);        // Envia sector 6 a BufferWrite_MF para grabar  !NO COMENTARIAR
1534   7                      }
1535   6                      tx_aux(CR);
1536   6                      tx_aux(LF);
1537   6                      Debug_Dividir_texto();
1538   6      //--------------------------------------------------------------------------------------------------
1539   6                      for (j=0; j<16; j++)              // Reintento
1540   6                      {
1541   7                        RetryWrite_MF[j]=sector5[j];
1542   7                      }         
1543   6      
1544   6                      Block=1;
1545   6                      Get_Status();
1546   6                      buffer_ready=0;
1547   6                      g_cEstadoComSeqMF=SEQ_RTA_STATUS_WR_B5;     //****************************aqui vamos
1548   6       //-------------------------------------------------------------------------------------------------- 
1549   6                    }
1550   5                    else
1551   5                    {
1552   6                      if (Desarmado==1)
1553   6                      {
1554   7                        Eject_Card(DESARM);
1555   7                      }
1556   6                      else
1557   6                      {
1558   7                        Eject_Card(CARD_EJECT);
1559   7                      } 
1560   6      
1561   6      
1562   6                    }
1563   5      
1564   5      
1565   5      
1566   5                  }
1567   4                  else
1568   4                  {
1569   5                    Eject_Card(ERR_COM);
1570   5                  }
1571   4          
1572   4                }
1573   3                else if ((buffer_ticket[3]=='M')&&(buffer_ticket[4]==':'))        //&&(num_data==12))
1574   3                {
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 27  

1575   4                    
1576   4                  TIME_ESPERA=0;
1577   4      
1578   4                  year=two_one(buffer_ticket[5],buffer_ticket[6]);            // FECHA DE VENCIMIENTO
1579   4                  year=bcd_hex(year);
1580   4                  
1581   4                  month=two_one(buffer_ticket[7],buffer_ticket[8]);
1582   4                  month=bcd_hex(month);
1583   4        
1584   4                  day=two_one(buffer_ticket[9],buffer_ticket[10]);
1585   4                  day=bcd_hex(day);
1586   4                     
1587   4                  sector5[8]=year;
1588   4                  sector5[9]=month;
1589   4                  sector5[10]=day;
1590   4      //--------------------------------------------------------------------------------------------------
1591   4                  Debug_Dividir_texto();          
1592   4                  Debug_txt_Tibbo((unsigned char *) "WR VENCIMIENTO 2 SEQ_RTA_STATUS_WR_B6:");    
1593   4                  
1594   4                  for (j=0; j<16; j++)
1595   4                  {
1596   5                    BufferWrite_MF[j]=sector5[j];
1597   5                    tx_auxH(BufferWrite_MF[j]);        // Envia sector 6 a BufferWrite_MF para grabar  !NO COMENTARIAR
1598   5                  }
1599   4                  tx_aux(CR);
1600   4                  tx_aux(LF);
1601   4                  Debug_Dividir_texto();
1602   4      //--------------------------------------------------------------------------------------------------
1603   4                  for (j=0; j<16; j++)              // Reintento
1604   4                  {
1605   5                    RetryWrite_MF[j]=sector5[j];
1606   5                  }         
1607   4      //--------------------------------------------------------------------------------------------------
1608   4                  Get_Status();
1609   4                  buffer_ready=0;
1610   4                  g_cEstadoComSeqMF=SEQ_RTA_STATUS_WR_B5;
1611   4                  g_cEstadoComSoft=ESPERA_RX;
1612   4                  ValTimeOutCom=10;
1613   4      
1614   4                }
1615   3                else if (buffer_ticket[3]=='o')
1616   3                {
1617   4                  TIME_ESPERA=0;
1618   4                  
1619   4                  GrabaTarjeta=0;
1620   4                  Desarmado=0;
1621   4                  Permite_Puerta=0;
1622   4                  Permite_Billetero=0;
1623   4                  Permite_Monedero=0;
1624   4                  NotifyCofreCoin=0;
1625   4                  NotifyCofreB2B=0;
1626   4                  NotifyPuerta=0;
1627   4                  }
1628   3                else if (buffer_ticket[3]=='E')
1629   3                {
1630   4                  TIME_ESPERA=0;
1631   4      
1632   4                  GrabaTarjeta=0;
1633   4                  Desarmado=0;
1634   4                  lock=0;
1635   4                  onceAlarm=0;
1636   4                  alarma1=0;
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 28  

1637   4                  alarma2=0;
1638   4                  alarma3=0;
1639   4                  Permite_Puerta=0;
1640   4                  Permite_Billetero=0;
1641   4                  Permite_Monedero=0;
1642   4                  NotifyCofreCoin=0;
1643   4                  NotifyCofreB2B=0;
1644   4                  NotifyPuerta=0;
1645   4                  }
1646   3                else if (buffer_ticket[3]=='F')
1647   3                {
1648   4                  FueraServicio=1;
1649   4                  TIME_ESPERA=0;
1650   4                  }
1651   3                else if (buffer_ticket[3]=='?')
1652   3                {
1653   4                  TIME_ESPERA=0;
1654   4                  Get_Status();
1655   4                  g_cEstadoComSeqMF=SEQ_RTA_STATUS2;
1656   4                  ConsultaSoft=1;
1657   4                  }
1658   3                else if ((buffer_ticket[3]=='U')&&(buffer_ticket[5]==ETX))
1659   3                {
1660   4                  
1661   4                  TIME_ESPERA=0;
1662   4      
1663   4                  if ((buffer_ticket[4]>=0x36)&&((buffer_ticket[4]<=0x39)))
1664   4                  {
1665   5                    buffer_ticket[3]=0X00;            //BORRA CMD
1666   5                  /*modificacion jp*/
1667   5                  
1668   5                    BufferWrite_MF[0]=buffer_ticket[4]-0X30;  // NIVEL SATATUS
1669   5                  
1670   5                    /*modificacion jp*/
1671   5                    BufferWrite_MF[1]=ID_CLIENTE;
1672   5                    BufferWrite_MF[2]=0X00;
1673   5                    BufferWrite_MF[3]=COD_PARK_R;
1674   5                    BufferWrite_MF[4]=0X00;
1675   5                    for (j=5; j<16; j++)
1676   5                    {
1677   6                      BufferWrite_MF[j]=0X00;
1678   6                    }
1679   5      
1680   5                    Block=1;
1681   5                    Graba_S1_BloqueSel(Block);          // B5
1682   5                    g_cEstadoComSeqMF=SEQ_RTA_WR;
1683   5      
1684   5                      Expulsa_Grabacion=1;
1685   5                    
1686   5                  }
1687   4                  else
1688   4                  {
1689   5                    Eject_Card(ERR_CARD_TIPO);
1690   5      
1691   5                  }
1692   4                  }
1693   3              }
1694   2              
1695   2              if  (ValTimeOutCom==1)
1696   2              {
1697   3      //          Get_Status();
1698   3      //          buffer_ready=0;
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 29  

1699   3      //          g_cEstadoComSeqMF=SEQ_RTA_STATUS2;
1700   3      //          g_cEstadoComSoft=ESPERA_RX;
1701   3      //          ValTimeOutCom=10;
1702   3              }
1703   2      
1704   2            break;
1705   2      //--------------------------------------------------------------------------------------------------------
             -----------------------*
1706   2      //      GRABACION DE FECHA DE VENCIMIENTO
1707   2      //--------------------------------------------------------------------------------------------------------
             -----------------------*
1708   2            case SEQ_RTA_STATUS_WR_B5:
1709   2      
1710   2              if ((ValTimeOutCom==1)||(buffer_ready==1))
1711   2              {
1712   3                if ((buffer_ready==1))
1713   3                {
1714   4                  buffer_ready=0;
1715   4                  if (g_scArrRxComSoft[5]=='Y')     
1716   4                  {
1717   5                      
1718   5                    Expulsa_Grabacion=1;              
1719   5                    RetryWR=4;                  // Numero de RE-Intentos 
1720   5                    Block=1;
1721   5                    Graba_S1_BloqueSel(Block);          // B5  //Sector 1 bloque 1 = Block(5) >> FECHA VENCIMIENTO
1722   5                    g_cEstadoComSeqMF=SEQ_RTA_WR;           
1723   5                  }
1724   4                  else
1725   4                  {
1726   5                    ErrorWR(NO_CARD);
1727   5                    Eject_Card(ERR_NO_CARD);
1728   5                    RetryWR=0;      
1729   5                    }
1730   4                }
1731   3                else
1732   3                {
1733   4                  ErrorWR(NO_RTA_WR);
1734   4                  Eject_Card(ERR_WR);
1735   4                  RetryWR=0;
1736   4                }
1737   3               }
1738   2      
1739   2            break;
1740   2      //--------------------------------------------------------------------------------------------------------
             -----------------------*
1741   2      //      GRABACION DE FECHA MAXIMA DE SALIDA
1742   2      //--------------------------------------------------------------------------------------------------------
             -----------------------*
1743   2            case SEQ_RTA_STATUS_WR_B6:
1744   2      
1745   2              if ((ValTimeOutCom==1)||(buffer_ready==1))
1746   2              {
1747   3                if ((buffer_ready==1))
1748   3                {
1749   4                  buffer_ready=0;
1750   4                  if (g_scArrRxComSoft[5]=='Y')     
1751   4                  {
1752   5                    Debug_txt_Tibbo((unsigned char *) "GRABACION DE FECHA maxima de salida"); 
1753   5                    Expulsa_Grabacion=1;              
1754   5                    RetryWR=4;                  // Numero de RE-Intentos 
1755   5                    LoadPass();                 // Sector 1 (bloque 2 = Block(6)) >> FECHA MAX DE SALIDA
1756   5                    g_cEstadoComSeqMF=SEQ_SEL_B6w;
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 30  

1757   5                  }
1758   4                  else
1759   4                  {
1760   5                    ErrorWR(NO_CARD);
1761   5                    Eject_Card(ERR_NO_CARD);
1762   5                    RetryWR=0;      
1763   5                    }
1764   4                }
1765   3                else
1766   3                {
1767   4                  ErrorWR(NO_RTA_WR);
1768   4                  Eject_Card(ERR_WR);
1769   4                  RetryWR=0;
1770   4                }
1771   3               }
1772   2      
1773   2       
1774   2      //--------------------------------------------------------------------------------------------------
1775   2            break;
1776   2      //--------------------------------------------------------------------------------------------------------
             -----------------------*
1777   2      /*------------------------------------------------------------------------------
1778   2      ------------------------------------------------------------------------------*/     
1779   2      
1780   2            case SEQ_RTA_STATUS_WR_B7:
1781   2      
1782   2              if ((ValTimeOutCom==1)||(buffer_ready==1))
1783   2              {
1784   3                
1785   3      
1786   3                if ((buffer_ready==1))
1787   3                {
1788   4                  buffer_ready=0;
1789   4                  if (g_scArrRxComSoft[5]=='Y')     
1790   4                  {
1791   5                    Debug_txt_Tibbo((unsigned char *) "Graba tipo de tarjeta perdida por rotacion\r\n");          
1792   5                    RetryWR=4;                  // Numero de RE-Intentos 
1793   5                    Block=1;
1794   5                    /*se graba tipo de tarjeta*/
1795   5                    Graba_S1_BloqueSel(Block);          // B5  //Sector 1 bloque 1 = Block(5) >> FECHA VENCIMIENTO
1796   5                    ValTimeOutCom=TIMWPoll;
1797   5                    g_cEstadoComSeqMF=SEQ_RTA_WR_2;           
1798   5                  }
1799   4                  else
1800   4                  {
1801   5                    ErrorWR(NO_CARD);
1802   5                    Eject_Card(ERR_NO_CARD);
1803   5                    RetryWR=0;      
1804   5                    }
1805   4                }
1806   3                else
1807   3                {
1808   4                  ErrorWR(NO_RTA_WR);
1809   4                  Eject_Card(ERR_WR);
1810   4                  RetryWR=0;
1811   4                }
1812   3               }
1813   2      
1814   2            break;  
1815   2      
1816   2      
1817   2            case SEQ_RTA_STATUS2:
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 31  

1818   2      
1819   2              if ((ValTimeOutCom==1)||(buffer_ready==1))
1820   2              {
1821   3      //--------------------------------------------------------------------          
1822   3      //          sel_com=PuertoMF;
1823   3      //          for (j=0; j<g_cContByteRx; j++)
1824   3      //          {
1825   3      //            tx_chr(g_scArrRxComSoft[j]);  
1826   3      //          }
1827   3      //          tx_chr(0xd);
1828   3      //          tx_chr(0xa);
1829   3      //          while (sendactive==1) 
1830   3      //          {
1831   3      //          }
1832   3      //          sel_com=PuertoDB9;
1833   3      //--------------------------------------------------------------------  
1834   3                if ((buffer_ready==1))
1835   3                {
1836   4                  if (g_scArrRxComSoft[5]=='Y')     
1837   4                  {
1838   5                      g_cEstadoComSeqMF=SEQ_WCMD;
1839   5                    g_cEstadoComSoft=ESPERA_RX;
1840   5                    ValTimeOutCom=500;
1841   5                    if (ConsultaSoft==1)
1842   5                    {
1843   6                      ConsultaSoft=0;
1844   6                      buffer_ticket[0]=STX;
1845   6                      buffer_ticket[1]='0';
1846   6                      buffer_ticket[2]=0x06;
1847   6                      buffer_ticket[3]='?';
1848   6                      buffer_ticket[4]=ACK;
1849   6                      buffer_ticket[5]=ETX;
1850   6                      Send_Port(6);
1851   6                    }
1852   5                  }
1853   4                  else 
1854   4                  {
1855   5                    ErrorWR(NO_CARD);
1856   5                    Eject_Card(ERR_NO_CARD);          //Eject_Card(ERR_WR);
1857   5                    RetryWR=0;
1858   5                    
1859   5                    g_cEstadoComSoft=ESPERA_RX;
1860   5                    ValTimeOutCom=TIMWPoll;
1861   5        
1862   5                    if (ConsultaSoft==1)
1863   5                    {
1864   6                      buffer_ticket[0]=STX;
1865   6                      buffer_ticket[1]='0';
1866   6                      buffer_ticket[2]=0X06;
1867   6                      buffer_ticket[3]='e';
1868   6                      buffer_ticket[4]=0x40;        //Tarjeta Mal Insertada
1869   6                      buffer_ticket[5]=ETX;
1870   6                      Send_Port(6);
1871   6                    }
1872   5                    else
1873   5                    {
1874   6      
1875   6                      buffer_ticket[0]=STX;
1876   6                      buffer_ticket[1]='0';
1877   6                      buffer_ticket[2]=0X05;
1878   6                      buffer_ticket[3]='X';
1879   6                      buffer_ticket[4]=ETX;
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 32  

1880   6                      Send_Port(5);  
1881   6        
1882   6                      FueraServicio=0;
1883   6                      GrabaTarjeta=0;
1884   6                      Desarmado=0;
1885   6        
1886   6                        Permite_Puerta=0;
1887   6                      Permite_Billetero=0;
1888   6                      Permite_Monedero=0;
1889   6                      NotifyCofreCoin=0;
1890   6                      NotifyCofreB2B=0;
1891   6                      NotifyPuerta=0;
1892   6                    }
1893   5                  }
1894   4                }
1895   3                else
1896   3                {
1897   4                      g_cEstadoComSeqMF=SEQ_WCMD;
1898   4                    g_cEstadoComSoft=ESPERA_RX;
1899   4                    ValTimeOutCom=500;
1900   4                }
1901   3                buffer_ready=0;     
1902   3              }
1903   2            break;
1904   2      //--------------------------------------------------------------------------------------------------------
             -----------------------*
1905   2      //      case SEQ_SEL_B5w:
1906   2      //        if ((ValTimeOutCom==1))
1907   2      //        {
1908   2      //          if ((buffer_ready==1)&&(g_scArrRxComSoft[3]=='P'))  // 0:SIN ERROR
1909   2      //          {
1910   2      //            Block=1;
1911   2      //            Graba_S1_BloqueSel(1);              // B5
1912   2      //            g_cEstadoComSeqMF=SEQ_RTA_WR; 
1913   2      //          }
1914   2      //          else
1915   2      //          {
1916   2      //            Eject_Card(ERR_SELECT);
1917   2      //          }
1918   2      //          buffer_ready=0;
1919   2      //          g_cEstadoComSoft=ESPERA_RX;
1920   2      //          ValTimeOutCom=TIMWPoll;
1921   2      //        }
1922   2      //      break;
1923   2      //********************************************************************************************************
             -***********************
1924   2            case SEQ_SEL_B6w:
1925   2              if ((ValTimeOutCom==1)||(buffer_ready==1))
1926   2              {
1927   3                if ((buffer_ready==1)&&(g_scArrRxComSoft[6]=='Y'))  // 0:SIN ERROR    
1928   3                {
1929   4                  buffer_ready=0;
1930   4                  Debug_txt_Tibbo((unsigned char *) "Grabando...\r\n");   
1931   4                      
1932   4                    
1933   4                  Block=2;
1934   4                  Graba_S1_BloqueSel(Block);
1935   4                  g_cEstadoComSeqMF=SEQ_RTA_WR;
1936   4                  Expulsa_Grabacion=1;
1937   4      
1938   4                  buffer_ready=0;
1939   4                  g_cEstadoComSoft=ESPERA_RX;
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 33  

1940   4                  ValTimeOutCom=TIMWPoll;
1941   4      
1942   4                }
1943   3                else
1944   3                {
1945   4                  Block=2;
1946   4                  ErrorWR(SELECCION_SECTOR);
1947   4                  g_cEstadoComSeqMF=SEQ_RETRY;            
1948   4                }
1949   3        
1950   3                buffer_ready=0;
1951   3                g_cEstadoComSoft=ESPERA_RX;
1952   3                ValTimeOutCom=TIMWPoll;
1953   3                }
1954   2      
1955   2            break;
1956   2      //********************************************************************************************************
             -***********************
1957   2           case SEQ_RTA_WR:
1958   2            if ((ValTimeOutCom==1)||(buffer_ready==1))
1959   2            {
1960   3                
1961   3              if ((buffer_ready==1)&&(g_scArrRxComSoft[7]=='Y'))        /*datos ok grabados en MF50*/
1962   3              {
1963   4                buffer_ready=0;
1964   4                Debug_txt_Tibbo((unsigned char *) "Comparando...\r\n");   
1965   4                        
1966   4      //----------------------------
1967   4      //----------------------------
1968   4                /*debug del dato grabado en la tarjeta sin verificacion*/
1969   4                tx_aux('R');
1970   4                tx_aux('D');
1971   4                tx_aux(':');
1972   4                for (j=0; j<16; j++)            // Lectura  sector 6
1973   4                {
1974   5                  tx_auxH(g_scArrRxComSoft[8+j]);   // Envia sector 6 leido
1975   5                }
1976   4                tx_aux(CR);
1977   4                tx_aux(LF);
1978   4      
1979   4      //          if ((BufferWrite_MF[11]==g_scArrRxComSoft[8])&&(BufferWrite_MF[12]==g_scArrRxComSoft[17])&&(BufferW
             -rite_MF[13]==g_scArrRxComSoft[18])&&(BufferWrite_MF[14]==g_scArrRxComSoft[19])&&(BufferWrite_MF[15]==g_scArrRxComSoft[20
             -]))
1980   4                
1981   4                Comparacion=1;
1982   4                for (j=0; j<16; j++)
1983   4                {
1984   5                  if (BufferWrite_MF[j]!=g_scArrRxComSoft[8+j])
1985   5                  {
1986   6                    j=16;
1987   6                    Comparacion=0;
1988   6                  }
1989   5                }
1990   4      
1991   4                if (Comparacion==1)
1992   4                {
1993   5                  if (Expulsa_Grabacion==1)
1994   5                  {
1995   6                    Debug_txt_Tibbo((unsigned char *) "CARD_EJECT_WR \r\n");
1996   6                    Eject_Card(CARD_EJECT_WR);
1997   6                    RetryWR=0;
1998   6                    Expulsa_Grabacion=0;
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 34  

1999   6                  }
2000   5                  else
2001   5                  {
2002   6                    Debug_txt_Tibbo((unsigned char *) "CARD_EJECT \r\n");
2003   6                    Eject_Card(CARD_EJECT);
2004   6                    RetryWR=0;
2005   6                  }
2006   5                  Debug_txt_Tibbo((unsigned char *) "GRABACION OK \r\n");   
2007   5                  
2008   5      
2009   5                  for (j=0; j<60; j++)
2010   5                  {
2011   6                    buffer_ticket[j]=0;
2012   6                  }
2013   5      
2014   5                  break;
2015   5                }
2016   4                else
2017   4                {
2018   5                  Debug_txt_Tibbo((unsigned char *) "DIFERENCIA \r\n");   
2019   5                  
2020   5        
2021   5                  g_cEstadoComSeqMF=SEQ_RETRY;
2022   5                  g_cEstadoComSoft=ESPERA_RX;
2023   5                  ValTimeOutCom=20;
2024   5                  buffer_ready=0;
2025   5                }
2026   4      
2027   4       //-----------------------------
2028   4      //------------------------------
2029   4      
2030   4              }
2031   3              else
2032   3              {
2033   4                if ((buffer_ready==1)&&(g_scArrRxComSoft[7]=='N'))
2034   4                {
2035   5                  buffer_ready=0;
2036   5                  ErrorWR(COMANDO_WR);
2037   5                }
2038   4                else if (buffer_ready==0)
2039   4                {
2040   5                  ErrorWR(NO_RTA_WR);
2041   5                }
2042   4                buffer_ready=0;
2043   4                g_cEstadoComSeqMF=SEQ_RETRY;
2044   4              }
2045   3              g_cEstadoComSoft=ESPERA_RX;
2046   3              ValTimeOutCom=TIMWPoll;
2047   3            }
2048   2           break;
2049   2      /*------------------------------------------------------------------------------
2050   2      ------------------------------------------------------------------------------*/      
2051   2            
2052   2            case SEQ_RTA_WR_2:
2053   2            if ((ValTimeOutCom==1)||(buffer_ready==1))
2054   2            {
2055   3                
2056   3              if ((buffer_ready==1)&&(g_scArrRxComSoft[7]=='Y'))        /*datos ok grabados en MF50*/
2057   3              {
2058   4                buffer_ready=0;
2059   4                Debug_txt_Tibbo((unsigned char *) "Reparando MF perdida...\r\n");   
2060   4                        
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 35  

2061   4                Debug_Dividir_texto();
2062   4      //----------------------------
2063   4                  for (j=0; j<16; j++)
2064   4                  {
2065   5                    BufferWrite_MF[j]=sector6[j];
2066   5                    tx_auxH(BufferWrite_MF[j]);        // Envia sector 6 a BufferWrite_MF para grabar  !NO COMENTARIAR
2067   5                  }
2068   4                    tx_aux(CR);
2069   4                    tx_aux(LF);
2070   4                  
2071   4      //--------------------------------------------------------------------------------------------------
2072   4                  for (j=0; j<16; j++)              // Reintento
2073   4                  {
2074   5                    RetryWrite_MF[j]=sector6[j];
2075   5                  }               
2076   4      
2077   4      
2078   4                /*debug del dato grabado en la tarjeta sin verificacion*/
2079   4                Debug_Dividir_texto();
2080   4              
2081   4                Block=2;                                /*graba fecha de salida*/
2082   4                Get_Status();
2083   4                buffer_ready=0;
2084   4                g_cEstadoComSeqMF=SEQ_RTA_STATUS_WR_B6; 
2085   4                
2086   4                g_cEstadoComSoft=ESPERA_RX;
2087   4                ValTimeOutCom=20;
2088   4                
2089   4                
2090   4                
2091   4       //-----------------------------
2092   4      //------------------------------
2093   4      
2094   4              }
2095   3              else
2096   3              {
2097   4                if ((buffer_ready==1)&&(g_scArrRxComSoft[7]=='N'))
2098   4                {
2099   5                  buffer_ready=0;
2100   5                  /*error de escritura mf50*/
2101   5                  ErrorWR(COMANDO_WR);
2102   5                }
2103   4                else if (buffer_ready==0)
2104   4                {
2105   5                  ErrorWR(NO_RTA_WR);
2106   5                }
2107   4                LoadPass(); 
2108   4                buffer_ready=0;
2109   4                g_cEstadoComSeqMF=SEQ_RETRY_KEY_2;              ///SEQ_RTA_STATUS_WR_B7;        //SEQ_RETRY;
2110   4              }
2111   3              g_cEstadoComSoft=ESPERA_RX;
2112   3              ValTimeOutCom=TIMWPoll;
2113   3            }
2114   2           break;     
2115   2      //------------------------------------------------------------------------------------------*
2116   2          case SEQ_RETRY:
2117   2            if (ValTimeOutCom==1)
2118   2            {
2119   3              if (RetryWR!=0)
2120   3              {
2121   4                Info_Retry();
2122   4              }
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 36  

2123   3              buffer_ready=0;
2124   3              g_cEstadoComSeqMF=SEQ_RETRY_ANTENA_OFF;
2125   3              g_cEstadoComSoft=ESPERA_RX;
2126   3              ValTimeOutCom=5;
2127   3            }
2128   2          break;
2129   2      //------------------------------------------------------------------------------------------*
2130   2          case SEQ_RETRY_ANTENA_OFF:
2131   2      
2132   2            if (ValTimeOutCom==1)
2133   2            {
2134   3              if (RetryWR!=0)
2135   3              {
2136   4                RetryWR--;
2137   4                Get_Status();                       /*valido si hay tarjeta en el lector*/
2138   4                g_cEstadoComSeqMF= SEQ_LEE_ID_BACKUP;     //SEQ_RETRY_CARD_INSIDE;
2139   4              }
2140   3              else
2141   3              {
2142   4                ErrorWR(FALLA_WR);
2143   4                Eject_Card(ERR_WR);
2144   4              }
2145   3              buffer_ready=0;
2146   3              g_cEstadoComSoft=ESPERA_RX;
2147   3              ValTimeOutCom=TIMWPoll;     
2148   3            }
2149   2      
2150   2          break;
2151   2      //------------------------------------------------------------------------------------------*
2152   2          case SEQ_RETRY_CARD_INSIDE:
2153   2            if ((ValTimeOutCom==1)||(buffer_ready==1))
2154   2            {
2155   3              if ((buffer_ready==1)&&(g_scArrRxComSoft[5]=='Y'))
2156   3              {
2157   4                Debug_txt_Tibbo((unsigned char *) "valida password SEQ_RETRY_KEY\r\n");
2158   4                LoadPass();                                 /*valido el password 1 en MF50*/
2159   4                g_cEstadoComSeqMF=SEQ_RETRY_KEY;
2160   4              }
2161   3              else
2162   3              {
2163   4                ErrorWR(NO_CARD);
2164   4                Eject_Card(ERR_NO_CARD);
2165   4                RetryWR=0;
2166   4              }
2167   3      
2168   3              buffer_ready=0;
2169   3              g_cEstadoComSoft=ESPERA_RX;
2170   3              ValTimeOutCom=TIMWPoll;
2171   3              }
2172   2          break;
2173   2      //------------------------------------------------------------------------------------------*
2174   2          case SEQ_RETRY_KEY:             /*envia cmd de grabar datos a MF50*/
2175   2      
2176   2            if ((ValTimeOutCom==1)||(buffer_ready==1))
2177   2            {
2178   3              if ((buffer_ready==1)&& (g_scArrRxComSoft[6]=='Y')) // 0:SIN ERROR
2179   3              {
2180   4                Graba_S1_BloqueSel(Block);                                                /*graba la MF50 con los datos recolectados*/
2181   4                g_cEstadoComSeqMF=SEQ_RTA_WR;
2182   4                Expulsa_Grabacion=1;
2183   4                  buffer_ready=0;
2184   4              }
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 37  

2185   3              else
2186   3              {
2187   4                Debug_txt_Tibbo((unsigned char *) "ERRR KER\r\n");    
2188   4              
2189   4                g_cEstadoComSeqMF=SEQ_RETRY;
2190   4              }
2191   3              buffer_ready=0;
2192   3              g_cEstadoComSoft=ESPERA_RX;
2193   3              ValTimeOutCom=TIMWPoll;
2194   3              }
2195   2      
2196   2          break;
2197   2      /*------------------------------------------------------------------------------------
2198   2      leo el numero de serie de la tarjeta y lo almaceno para compararlo        
2199   2      ------------------------------------------------------------------------    ---------*/
2200   2          case SEQ_LEE_ID_BACKUP:
2201   2          if ((ValTimeOutCom==1)||(buffer_ready==1))
2202   2            {
2203   3              if ((buffer_ready==1)&&(g_scArrRxComSoft[5]=='Y'))      /*Tarjeta en el lector*/
2204   3              {
2205   4                Debug_txt_Tibbo((unsigned char *) "TARJETA LOCK\r\n");
2206   4                Select_Card();                                    /*consulto el numero de la serie de la tarjeta*/
2207   4                g_cEstadoComSeqMF=SEQ_BRTA_ID_BACKUP;
2208   4      
2209   4              }
2210   3              else
2211   3              {
2212   4                ErrorWR(NO_CARD);
2213   4                Eject_Card(ERR_NO_CARD);
2214   4                RetryWR=0;
2215   4              }
2216   3      
2217   3              buffer_ready=0;
2218   3              g_cEstadoComSoft=ESPERA_RX;
2219   3              ValTimeOutCom=TIMWPoll;
2220   3              }
2221   2          break;  
2222   2          
2223   2      /*------------------------------------------------------------------------------------
2224   2      almaceno el numero del Id leido y lo comparo con el anterior      
2225   2      ------------------------------------------------------------------------    ---------*/
2226   2          case  SEQ_BRTA_ID_BACKUP:  //DEBE SER SEQ_RETRY_CARD_INSIDE
2227   2            if (buffer_ready==1)
2228   2              {
2229   3                buffer_ready=0;
2230   3                if (g_scArrRxComSoft[5]=='Y')
2231   3                {
2232   4                  /*Y= tiene el numero de la tarjeta
2233   4                    N= fallo el numero de tarjeta
2234   4                    E= no hay tarjeta
2235   4                  */
2236   4                  BID1=g_scArrRxComSoft[6];                     /*numero de serie de la tarjeta enviado a tcp/ip*/
2237   4                  BID2=g_scArrRxComSoft[7];
2238   4                  BID3=g_scArrRxComSoft[8];
2239   4                  BID4=g_scArrRxComSoft[9];
2240   4                  Debug_txt_Tibbo((unsigned char *) "CARD_BACKUP: \r\n");
2241   4                  
2242   4                  Ve_Hex(g_scArrRxComSoft[6]);      // 
2243   4                  tx_aux(decena);
2244   4                  tx_aux(unidad);
2245   4                  tx_aux(' ');
2246   4                  
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 38  

2247   4                  Ve_Hex(g_scArrRxComSoft[7]);      // 
2248   4                  tx_aux(decena);
2249   4                  tx_aux(unidad);
2250   4                  tx_aux(' ');            
2251   4      
2252   4                  Ve_Hex(g_scArrRxComSoft[8]);      // 
2253   4                  tx_aux(decena);
2254   4                  tx_aux(unidad);
2255   4                  tx_aux(' ');
2256   4      
2257   4                  Ve_Hex(g_scArrRxComSoft[9]);      // 
2258   4                  tx_aux(decena);
2259   4                  tx_aux(unidad);
2260   4                  tx_aux(' ');
2261   4      
2262   4                  tx_aux(CR);
2263   4                  tx_aux(LF);                           
2264   4                  
2265   4                  if ((ID1==BID1)&& (ID2==BID2)&& (ID3==BID3)&& (ID4==BID4)== 1)
2266   4                  {
2267   5                  Get_Status(); 
2268   5                  g_cEstadoComSeqMF=SEQ_RETRY_CARD_INSIDE;
2269   5                  buffer_ready=0;   
2270   5                  }
2271   4                  else
2272   4                  {
2273   5                    Debug_txt_Tibbo((unsigned char *) "ERROR NO ES LA MISMA CARD\r\n");
2274   5                    
2275   5                    Eject_Card(ERR_SELECT);;
2276   5                  }
2277   4                  
2278   4                  
2279   4                              
2280   4                }
2281   3                else
2282   3                {
2283   4                  Debug_txt_Tibbo((unsigned char *) "ERROR CARD\r\n");
2284   4                    
2285   4                  Eject_Card(ERR_SELECT);;
2286   4                }
2287   3       
2288   3              }
2289   2              else if (ValTimeOutCom==1)
2290   2              {
2291   3                Debug_txt_Tibbo((unsigned char *) "SIN RTA. SELECT\r\n");
2292   3                Eject_Card(ERR_RD);
2293   3      
2294   3              }
2295   2      
2296   2            break;
2297   2          case SEQ_RETRY_KEY_2:             /*envia cmd de grabar datos a MF50*/
2298   2      
2299   2            if ((ValTimeOutCom==1)||(buffer_ready==1))
2300   2            {
2301   3              if ((buffer_ready==1)&& (g_scArrRxComSoft[6]=='Y')) // 0:SIN ERROR
2302   3              {
2303   4                Graba_S1_BloqueSel(Block);                                                /*graba la MF50 con los datos recolectados*/
2304   4                g_cEstadoComSeqMF=SEQ_RTA_WR_2;
2305   4                
2306   4                  buffer_ready=0;
2307   4              }
2308   3              else
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 39  

2309   3              {
2310   4                /*error clave no la recibe*/
2311   4                Debug_txt_Tibbo((unsigned char *) "ERRR KER\r\n");    
2312   4              
2313   4                g_cEstadoComSeqMF=SEQ_RETRY_KEY_2;
2314   4              }
2315   3              buffer_ready=0;
2316   3              g_cEstadoComSoft=ESPERA_RX;
2317   3              ValTimeOutCom=TIMWPoll;
2318   3              }
2319   2      
2320   2          break;
2321   2              
2322   2              /* redirecciono el pto serie para leer en QR*/
2323   2          case SEQ_QR_WAIT:
2324   2            if ((ValTimeOutCom == 1)||(buffer_ready != 0))
2325   2            {
2326   3              Debug_txt_Tibbo((unsigned char *) "\r\nlector datalogic cod QR SEQ_QR_WAIT\r\n"); 
2327   3              if ((g_cContByteRx=='E')|| (g_cContByteRx=='D'))
2328   3              {
2329   4                g_cEstadoComSeqMF=SEQ_QR_PTPRL;                                                   
2330   4                g_cEstadoComSoft=RX_QR;
2331   4                ValTimeOutCom=3;    
2332   4              }
2333   3              else
2334   3              {
2335   4              buffer_ready =0;
2336   4              sel_com=PuertoMF;                                           /*pto serial redireccionado*/
2337   4              esQR=1;
2338   4              g_cEstadoComSeqMF=SEQ_QR_INICIO;                            /*no hay tarjeta probamos si hay QR*/
2339   4              g_cEstadoComSoft=RX_QR;
2340   4              ValTimeOutCom=TIMConsulta;                        //TIMWPoll;                                     /*se espera el dato del qr*/
2341   4              g_cContByteRx=0;    
2342   4              }         /*contador de bits en cero*/
2343   3            }
2344   2      
2345   2            break;
2346   2      
2347   2            /*inicia la lectura del ticket*/
2348   2          case  SEQ_QR_INICIO:
2349   2            if ((ValTimeOutCom == 1)||(buffer_ready != 0))
2350   2            {
2351   3              if (buffer_ready == 1)
2352   3              {
2353   4              
2354   4                /*trama con codigo QR*/
2355   4                Debug_txt_Tibbo((unsigned char *) "\r\nQR SEQ_QR_INICIO\r\n");  
2356   4                Debug_txt_Tibbo((unsigned char *) "\r\ntrama del lector datalogic cod QR\r\n");             /*la respuesta 
             -es desconocida*/
2357   4                Debug_txt_Tibbo(g_scArrRxComSoft);                                                          /*imprimo la trama recibida*/
2358   4                Debug_txt_Tibbo((unsigned char *) "\r\n");
2359   4              
2360   4                        
2361   4                g_cEstadoComSeqMF=SEQ_QR_PTPRL;                                                   
2362   4                g_cEstadoComSoft=RX_QR;
2363   4                ValTimeOutCom=3;        
2364   4              }
2365   3              else 
2366   3              {
2367   4                if (contador_QR==5)
2368   4                { 
2369   5                /*no hay datos QR se va a trajetas*/
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 40  

2370   5                  Debug_txt_Tibbo((unsigned char *) " HABILITO TARJETAS SEQ_QR_INICIO\r\n");
2371   5                  contador_QR=0;
2372   5                  ES = 1;     
2373   5                  esQR=0;
2374   5                  sel_com=PuertoDB9;
2375   5                  buffer_ready=0;                                   /* buffer del pto serie (0) inicia a esperar la trama*/
2376   5                  g_cEstadoComSeqMF=SEQ_INICIO;                     /*no hay tarjeta probamos si hay QR*/
2377   5                  g_cEstadoComSoft=ESPERA_RX;
2378   5                  ValTimeOutCom=T_WAIT;
2379   5                }
2380   4                else 
2381   4                { 
2382   5                  contador_QR++;
2383   5                  ES = 1;                                                       /*activo pto serie*/          
2384   5                  esQR=1;                                                       /*habilito el pto serial del QR */
2385   5                  sel_com=PuertoMF;                                             /*PuertoMF*/
2386   5                  buffer_ready=0;                                               /* limpio el buffer*/
2387   5                  g_cContByteRx=0 ;           
2388   5                  g_cEstadoComSeqMF=SEQ_QR_INICIO;                                /*no hay tarjeta probamos si hay QR*/
2389   5                  g_cEstadoComSoft=RX_QR;
2390   5                  ValTimeOutCom=TIMConsulta;                                          /*TIMConsulta=1200*/
2391   5                }
2392   4                
2393   4            }
2394   3          break;  
2395   3      
2396   3      
2397   3            /*tengo el dato del ticket QR */
2398   3          
2399   3          case SEQ_QR_PTPRL: 
2400   3            if ((ValTimeOutCom == 1)||(buffer_ready != 0))  
2401   3            {
2402   4            /*analizo los datos*/
2403   4            ES = 0;                                                     /*inactivo pto serie y analizo el dato*/  
2404   4            Debug_txt_Tibbo((unsigned char *) "cod SEQ_QR_PTPRL r\n");
2405   4            buffer_ticket[0]=STX;                                       // Inicio de transmision TRAMA QR
2406   4            buffer_ticket[1]='0';                                       // Direccion del pc
2407   4            buffer_ticket[2]='L';                                       /*numero de digitos de la trama se modifica al final*/  
2408   4            buffer_ticket[3]='Q';                                       /*cmd de cobro del cajero L tarjeta Q cobro por QR*/  
2409   4            buffer_ticket[4]=0; 
2410   4            num_data=4;
2411   4            
2412   4            Debug_Dividir_texto() ;                                                         // Posicion 2 = Numero de Caracteres enviados
2413   4            Debug_txt_Tibbo((unsigned char *) "numero de digitos de la tramar\n");
2414   4            tx_aux(g_cContByteRx);  
2415   4            Debug_txt_Tibbo((unsigned char *) "\r\n");                  /*final de linea*/      
2416   4            Debug_Dividir_texto() ;     
2417   4             /*se analiza la trama recibida */
2418   4            temp=num_num(g_scArrRxComSoft);                             /*funcion que pregunta donde empieza el primer numero del
             - ticket*/
2419   4            temp2=num_char(g_scArrRxComSoft+temp,'>');                  /*busca un caracter en la trama en este caso el cara
             -cter final de la trama*/
2420   4            
2421   4            if ((tipo_vehiculo=strstr(g_scArrRxComSoft,"Carro"))!= 0)   /*pregunto el tipo de vehiculo grabado en el
             - codigo QR*/
2422   4                {
2423   5                vehiculo='C';
2424   5                }
2425   4              else
2426   4                {
2427   5                vehiculo='M';
2428   5                }
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 41  

2429   4                /*informacion del tipo de vehiculo y la longitud del ticket*/
2430   4              Debug_txt_Tibbo((unsigned char *) "tipo de vehiculo: ");    /*msj tipo de vehiculo */
2431   4              tx_aux(vehiculo);                                           /*caracter del tipo de vehiculo*/
2432   4              Debug_txt_Tibbo((unsigned char *) "\r\n");                  /*final de linea*/
2433   4              
2434   4              Debug_txt_Tibbo((unsigned char *) "longitud de la trama: ");/*msj longitud de la trama */
2435   4              tx_auxH(temp);                                              /*numero de inicio del ticket*/
2436   4              Debug_txt_Tibbo((unsigned char *) "\r\n");                  /*final de linea*/                          
2437   4              Debug_txt_Tibbo((unsigned char *) "longitud del Ticket: ");
2438   4              tx_auxH(temp2);                                             /*numero de caracteres del ticket*/
2439   4              Debug_txt_Tibbo((unsigned char *) "\r\n");                  /*final de linea*/
2440   4              Ticket[0]=0;
2441   4                
2442   4              /*validamos la trama */
2443   4              if(temp== 0x0c)                                             /*la trama debe iniciar en 0x0c*/
2444   4              { 
2445   5                strncpy(Ticket,g_scArrRxComSoft+temp,temp2);                /*copio el numero de ticket*/
2446   5                Ticket[temp2]=0;  
2447   5                num_data=strlen(Ticket);                                    /*longitud del ticket*/
2448   5                strncat(buffer_ticket,Ticket,num_data);                     /*copio el numero de ticket al buffer del pto paral
             -elo*/
2449   5                strcat(buffer_ticket,":");                                  /*copio el separador de la trama*/  
2450   5              
2451   5                /*imprimo el numero del ticket*/
2452   5                Debug_txt_Tibbo((unsigned char *) "Numero del Ticket: ");       
2453   5                Debug_txt_Tibbo(Ticket);                                    /*imprimo el numero de ticket*/
2454   5                Debug_txt_Tibbo((unsigned char *) "\r\n");                  /*final de linea*/
2455   5                
2456   5                
2457   5                
2458   5                
2459   5                /*leo la fecha de ingreso del ticket en QR*/
2460   5              
2461   5                if ((tipo_vehiculo = strstr(g_scArrRxComSoft,"Fecha:"))!= 0);
2462   5                {
2463   6                  strncpy(fecha,tipo_vehiculo+7,16);  
2464   6                  /*imprimo en el lcd fechad e ingreso en el ticket QR*/
2465   6                  Debug_txt_Tibbo((unsigned char *) "Fecha de ingreso: ");  /*trama de fecha*/
2466   6                  Debug_txt_Tibbo(fecha);
2467   6                  Debug_txt_Tibbo((unsigned char *) "\r\n");                /*final de linea*/
2468   6                  /*copio al año*/
2469   6                  strncat(buffer_ticket,fecha+2,2);                         /*copio el año a la trama*/
2470   6                  /*copio el mes */
2471   6                  strncat(buffer_ticket,fecha+5,2);                         /*copio el mes a la trama */
2472   6                  /*copio el dia */
2473   6                  strncat(buffer_ticket,fecha+8,2);                         /*copio el dia*/
2474   6                  /*copio la hora */
2475   6                  strncat(buffer_ticket,fecha+11,2);                        /*copio la hora*/
2476   6                  /*copio los minutos */
2477   6                  strncat(buffer_ticket,fecha+14,2);                        /*copio los minutos*/
2478   6                  
2479   6                  strcat(buffer_ticket,":");
2480   6      
2481   6      
2482   6      
2483   6                if (vehiculo=='C')                                          /*se escribe el tipo de vehiculo a la trama*/
2484   6                  {
2485   7                  strcat(buffer_ticket,"C");
2486   7                  } 
2487   6                  else
2488   6                  {
2489   7                  strcat(buffer_ticket,"M");
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 42  

2490   7                  }         
2491   6                strcat(buffer_ticket,":0:");                                  /*separador de la trama, codigo del comercio y separador
             - */    
2492   6              
2493   6                
2494   6              
2495   6                /*leo la fecha de salida del ticket en QR*/
2496   6              
2497   6              
2498   6              
2499   6                  strcat(buffer_ticket,"0000000000:1::");                             /*separador, tipo de tarjeta, separador,separa
             -dor*/
2500   6                  num_data=strlen(buffer_ticket);
2501   6                  buffer_ticket[num_data]=0x03;                                 /*el final de la trama ETX*/
2502   6                  buffer_ticket[2]=num_data+1;
2503   6                  Debug_txt_Tibbo((unsigned char *) "Trama pto paralelo\r\n ");/*trama del pto paralelo*/
2504   6                  DebugBufferMF(buffer_ticket,num_data+1);                      /*muestro la trama q se va enviar al pto paralelo
             -*/
2505   6              
2506   6                  /*envio pto paralelo*/
2507   6                  Send_Port(num_data+1);                // ENVIA AL PRINCIPAL
2508   6                    if  (timeOut==1)
2509   6                    {
2510   7                      Send_Port(num_data+1);
2511   7                    }
2512   6                    TIME_ESPERA=CTE_SEG*30;   
2513   6              
2514   6      
2515   6                    /*trama ok */
2516   6                  
2517   6                  
2518   6                  ES = 1;                                                       /*activo pto serie*/          
2519   6                  esQR=1;                                                       /*habilito el pto serial */
2520   6                  sel_com=PuertoMF;   
2521   6                  g_cContByteRx=0;              //PuertoDB9;PuertoMF
2522   6                  buffer_ready=0;                                             /* buffer del pto serie (0) inicia a esperar la trama*/
2523   6                  g_cEstadoComSeqMF=SEQ_QR_WCMD;                                /*no hay tarjeta probamos si hay QR*/
2524   6                  g_cEstadoComSoft=RX_QR;
2525   6                  ValTimeOutCom=T_WAIT;
2526   6                
2527   6                }
2528   5              
2529   5                
2530   5              } 
2531   4              else
2532   4              
2533   4              { 
2534   5                /*error los caracteres no estan completas se espera volver a leer el dato*/   
2535   5                Debug_txt_Tibbo((unsigned char *) "ERROR caracteres incompletos QR\r\n ");/*trama del pto paralelo*/  
             -        
2536   5                ES = 1;       
2537   5                sel_com=PuertoMF; 
2538   5                g_cContByteRx=0;
2539   5                esQR=1;
2540   5                buffer_ready=0; 
2541   5                g_cEstadoComSeqMF=SEQ_QR_INICIO;                      /*no hay tarjeta probamos si hay QR*/
2542   5                g_cEstadoComSoft=RX_QR;
2543   5                ValTimeOutCom=TIMWPoll;
2544   5              }
2545   4            } 
2546   3              
2547   3              
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 43  

2548   3            break;
2549   3      //------------------------------------------------------------------------------------------*
2550   3            case SEQ_QR_WCMD:
2551   3              
2552   3          
2553   3                  if (TIME_ESPERA==1)
2554   3              {
2555   4                
2556   4      //-------------------------------------------------------------------------------------------*
2557   4                Debug_txt_Tibbo((unsigned char *) " TIME OUT QR\r\n");
2558   4                if (contador_QR==5)
2559   4                {
2560   5                  
2561   5                  Debug_txt_Tibbo((unsigned char *) " HABILITO TARJETAS \r\n");
2562   5                  TIME_ESPERA=0;
2563   5                  esQR=0;
2564   5                  sel_com=PuertoDB9;
2565   5                  Get_Status();
2566   5                    
2567   5                  buffer_ready=0;                                   /* buffer del pto serie (0) inicia a esperar la trama*/
2568   5                  g_cEstadoComSeqMF=SEQ_INICIO;                     /*no hay tarjeta probamos si hay QR*/
2569   5                  g_cEstadoComSoft=ESPERA_RX;
2570   5                  ValTimeOutCom=T_WAIT;
2571   5                }
2572   4                else
2573   4                {
2574   5                  contador_QR++;
2575   5                  TIME_ESPERA=0;  
2576   5                  ES = 1;                                                       /*activo pto serie*/          
2577   5                  esQR=1;                                                       /*habilito el pto serial del QR */
2578   5                  sel_com=PuertoMF;                                             /*PuertoMF*/
2579   5                  buffer_ready=0;                                               /* limpio el buffer*/
2580   5                  g_cContByteRx=0 ;           
2581   5                  g_cEstadoComSeqMF=SEQ_QR_INICIO;                                /*no hay tarjeta probamos si hay QR*/
2582   5                  g_cEstadoComSoft=RX_QR;
2583   5                  ValTimeOutCom=TIMConsulta;
2584   5                }
2585   4      //-------------------------------------------------------------------------------------------*          
2586   4      
2587   4              }
2588   3              else 
2589   3              { 
2590   4                 if (busy==0)                                       /*recive informacion pto paralelo*/
2591   4                {
2592   5                  recibe_port();
2593   5      
2594   5                  if ((buffer_ticket[0]==ACK)&&(num_data==1))
2595   5                  {
2596   6                  TIME_ESPERA=0;
2597   6      
2598   6                  }
2599   5      
2600   5      //-------------------------------------------------------------------------------------------*
2601   5        
2602   5                if (buffer_ticket[3]=='O')        //eject
2603   5                {
2604   6                  TIME_ESPERA=0;
2605   6      //-------------------------------------------------------------------------------------------*
2606   6              
2607   6                  /*solo ejecta MF cancela  la transaccion */
2608   6                  if (num_data==5)                
2609   6                  {
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 44  

2610   7                   Debug_txt_Tibbo((unsigned char *) "\r\nEXPULSA transaccion CANCELADA\r\n"); 
2611   7      
2612   7                    tx_aux('P');
2613   7                    tx_aux('C');
2614   7                    tx_aux(':');
2615   7                    for (j=0; j<5; j++)
2616   7                    {
2617   8                      tx_aux(buffer_ticket[j]); 
2618   8                    }
2619   7                  TIME_ESPERA=0;  
2620   7                  ES = 1;                                                       /*activo pto serie*/          
2621   7                  esQR=1;                                                       /*habilito el pto serial del QR */
2622   7                  sel_com=PuertoMF;                                             /*PuertoMF*/
2623   7                  buffer_ready=0;                                               /* limpio el buffer*/
2624   7                  g_cEstadoComSeqMF=SEQ_QR_INICIO;                                /*no hay tarjeta probamos si hay QR*/
2625   7                  g_cEstadoComSoft=RX_QR;
2626   7                  ValTimeOutCom=TIMConsulta;                                      //T_WAIT;
2627   7                    break;
2628   7                  } 
2629   6      
2630   6                    /*transaccion ok*/        
2631   6                   else if (num_data>=16)
2632   6                  {
2633   7        
2634   7      //-------------------------------------------------------------------------------------------*
2635   7                    Debug_txt_Tibbo((unsigned char *) "\r\nPC: RX dato pto paralelo QR con fecha out\r\n");
2636   7                    Debug_Dividir_texto();
2637   7                    for (j=0; j<num_data; j++)
2638   7                    {
2639   8                      tx_aux(buffer_ticket[j]); 
2640   8                    }
2641   7                    tx_aux(0X0d);
2642   7                    tx_aux(0X0a);
2643   7                    Debug_Dividir_texto();
2644   7      //-------------------------------------------------------------------------------------------*
2645   7                    
2646   7                      
2647   7                      if (contador_QR==5)
2648   7                      { 
2649   8                      Debug_txt_Tibbo((unsigned char *) "\r\nHABILITO LECTURA DE TARJETA \r\n");  
2650   8                      contador_QR=0;
2651   8                      TIME_ESPERA=0;
2652   8                      esQR=0;
2653   8                      sel_com=PuertoDB9;
2654   8                      Get_Status();
2655   8                      
2656   8                      buffer_ready=0;                                   /* buffer del pto serie (0) inicia a esperar la trama*/
2657   8                      g_cEstadoComSeqMF=SEQ_RTA_STATUS;                     /*no hay tarjeta probamos si hay QR*/
2658   8                      g_cEstadoComSoft=ESPERA_RX;
2659   8                      ValTimeOutCom=T_WAIT;
2660   8                      }
2661   7                      else 
2662   7                      {
2663   8                        contador_QR++;
2664   8                        TIME_ESPERA=0;  
2665   8                        ES = 1;                                                       /*activo pto serie*/          
2666   8                        esQR=1;                                                       /*habilito el pto serial del QR */
2667   8                        sel_com=PuertoMF;                                             /*PuertoMF*/
2668   8                        buffer_ready=0;                                               /* limpio el buffer*/
2669   8                        g_cEstadoComSeqMF=SEQ_QR_INICIO;                                /*no hay tarjeta probamos si hay QR*/
2670   8                        g_cEstadoComSoft=RX_QR;
2671   8                        ValTimeOutCom=TIMConsulta;    
C51 COMPILER V9.59.0.0   LECTOR                                                            11/25/2021 12:37:17 PAGE 45  

2672   8                      }
2673   7                  }
2674   6                              /**/
2675   6      //--------------------------------------------------------------------------------------------------
2676   6                }
2677   5                    
2678   5                  
2679   5              
2680   5              }
2681   4            }
2682   3          }
2683   2                break;
2684   2          
2685   2            case SEQ_RECARGA_PASSWORD:
2686   2      
2687   2              if ((ValTimeOutCom==1)||(buffer_ready==1))
2688   2              {
2689   3                if ((buffer_ready==1))
2690   3                {
2691   4                  buffer_ready=0;
2692   4                  if (g_scArrRxComSoft[5]=='Y')     
2693   4                  {
2694   5                    Debug_txt_Tibbo((unsigned char *) "RECARGA EL PASSWORD"); 
2695   5                    Expulsa_Grabacion=1;              
2696   5                    RetryWR=4;                  // Numero de RE-Intentos 
2697   5                    LoadPass();
2698   5                    /*SE REESCRIBE EL SECTOR1 Y BLOQUE 1*/ 
2699   5                    g_cEstadoComSeqMF=SEQ_RTA_STATUS_WR_B7;
2700   5                  }
2701   4                  else
2702   4                  {
2703   5                    ErrorWR(NO_CARD);
2704   5                    Eject_Card(ERR_NO_CARD);
2705   5                    RetryWR=0;      
2706   5                    }
2707   4                }
2708   3                else
2709   3                {
2710   4                  ErrorWR(NO_RTA_WR);
2711   4                  Eject_Card(ERR_WR);
2712   4                  RetryWR=0;
2713   4                }
2714   3               }
2715   2      
2716   2            
2717   2            
2718   2        }
2719   1          
2720   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   9485    ----
   CONSTANT SIZE    =   1570    ----
   XDATA SIZE       =     33      12
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
